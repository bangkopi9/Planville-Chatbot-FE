<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="theme-color" content="#0f766e"/>
  <title>Planville AI Chatbot — Wattson</title>

  <!-- ===== CSS utama ===== -->
  <link rel="stylesheet" href="style.css"/>

  <!-- ===== PWA + Icons ===== -->
  <link rel="manifest" href="manifest.json"/>
  <!-- Fallback icon (png) + SVG icon (Wattson) – keduanya di root -->
  <link rel="icon" href="planville-logo.png" type="image/png"/>
  <link rel="icon" href="wattson.svg" type="image/svg+xml"/>

  <!-- ===== Network performance hints (sesuaikan dengan config.js) ===== -->
  <link rel="preconnect" href="https://web-production-352d9.up.railway.app" crossorigin>
  <link rel="dns-prefetch" href="//web-production-352d9.up.railway.app">

  <!-- ===== Global Config (single source) ===== -->
  <!-- NOTE: config.js berisi BASE_API_URL, flags UI, dll. -->
  <script defer src="config.js"></script>

  <!-- ===== Hard kill-switch CSS (rating & cookie banner di dalam chatbot) ===== -->
  <style>
    /* Sembunyikan rating 👍👎 kalau masih ada di komponen */
    #chatbot .rating, #chatbot .thumbs, #chatbot .thumb-up, #chatbot .thumb-down,
    #chatbot [data-role="feedback"] { display:none !important; }

    /* Pastikan tidak ada cookie banner di DALAM chatbot */
    #chatbot .cookie-banner,
    #chatbot [data-cookie-banner],
    #chatbot [class*="cookie"],
    #chatbot .cmp,
    #chatbot .consent {
      display:none !important; visibility:hidden !important; pointer-events:none !important;
    }

    /* Performa UI: kurangi layout work untuk konten di luar viewport */
    .chat-scroll * { content-visibility:auto; contain-intrinsic-size:200px; }

    /* ====== Header layout + Wattson badge (aesthetic) ====== */
    .chatbot-header{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding:10px 12px; border-bottom:1px solid #e8e8e8;
      background:#fff; position:sticky; top:0; z-index:2;
    }
    .chatbot-header .brand-left{display:flex; align-items:center; gap:10px}
    .chatbot-logo{height:28px; width:auto}
    .wattson-badge{
      display:flex; align-items:center; gap:8px;
      font-weight:600; color:#0f766e; background:#f1f5f9;
      padding:6px 10px; border-radius:999px;
      box-shadow: 0 1px 0 rgba(0,0,0,.05) inset;
      user-select:none;
    }
    .wattson-badge img{width:18px; height:18px; display:block}
    @media (max-width:480px){
      .wattson-badge{padding:4px 8px; font-size:.9rem}
      .chatbot-logo{height:24px}
    }
  </style>
</head>

<body>
  <!-- 📌 Sidebar FAQ -->
  <aside class="faq-sidebar" aria-label="FAQ">
    <h2>Frequently Asked Questions</h2>
    <ul id="faq-list"></ul>
  </aside>

  <!-- 💬 Main Chatbot UI -->
  <main class="chatbot-container" id="chatbot" role="dialog" aria-label="Planville Chat – Wattson" aria-modal="false">
    <div class="chatbot-header">
      <!-- Kiri: Logo Planville + Judul -->
      <div class="brand-left">
        <img src="planville-logo.png" alt="Planville" class="chatbot-logo" loading="lazy" decoding="async"/>
        <h1 id="chatbotTitle">Chat mit Wattson</h1>
      </div>
      <!-- Kanan: Badge Wattson -->
      <div class="wattson-badge" aria-label="Powered by Wattson">
        <img src="wattson.svg" alt="" loading="lazy" decoding="async"/>
        <span>Wattson</span>
      </div>
    </div>

    <div id="chatbot-log" class="chat-scroll" aria-live="polite" aria-atomic="false"></div>
    <div id="typing-bubble" class="chatbot-message bot-message typing-bubble" style="display:none">...</div>

    <form id="chatbot-form" autocomplete="off" aria-label="Chat-Eingabe">
      <label for="chatbot-input" class="sr-only" aria-hidden="true">Frage eingeben</label>
      <input id="chatbot-input" type="text" inputmode="text" autocomplete="off" placeholder="Stell deine Frage…" aria-required="true"/>
      <button type="submit" aria-label="Senden">💬</button>
    </form>

    <!-- Language switch -->
    <div class="language-switcher">
      <label for="langSwitcher">🌐 Language:</label>
      <select id="langSwitcher" aria-label="Sprache wählen">
        <option value="de">🇩🇪 Deutsch</option>
        <option value="en">🇬🇧 English</option>
      </select>
    </div>
  </main>

  <!-- 🟡 Floating Trigger: Wattson (pakai root svg) -->
  <button id="pv-chat-trigger" class="pv-chat-btn" type="button" aria-label="Chat mit Wattson öffnen">
    <img src="wattson.svg" alt="" class="pv-chat-avatar" width="28" height="28" loading="lazy" decoding="async"/>
    <span class="pv-chat-label">Wattson</span>
  </button>

  <!-- ⚙️ AI guard (patched) + Chatbot core -->
  <script defer src="ai_guardrails_vlite.patched.js"></script>
  <script defer src="chatbot.js"></script>

  <!-- 🧠 GA4 & Event/Lead helpers + Scoring v4 (+ popup-only flow) -->
  <script>
    /* ---------- Consent & Analytics Gate ---------- */
    function getConsentState(){
      try {
        const raw = localStorage.getItem("consent_v1");
        if (raw) {
          const c = JSON.parse(raw);
          return { essential:true, analytics:!!c.analytics, marketing:!!c.marketing, personalization:!!c.personalization };
        }
      } catch(_) {}
      const simple = localStorage.getItem("cookieConsent");
      return { essential:true, analytics:simple==="accepted", marketing:false, personalization:false };
    }
    function allowAnalytics(){ return !!getConsentState().analytics; }

    // FE events (gated)
    function trackFE(eventName, props = {}, { essential = false } = {}) {
      if (!essential && !allowAnalytics()) return;
      try {
        window.dataLayer = window.dataLayer || [];
        const variant = localStorage.getItem("ab_variant") || "A";
        window.dataLayer.push(Object.assign({ event: eventName, variant }, props));
      } catch(_) {}
      try {
        // _api didefinisikan di chatbot.js yang sudah dimuat sebelumnya
        fetch(_api("/track"), {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({ event: eventName, props: Object.assign({ variant: localStorage.getItem("ab_variant") || "A" }, props) })
        });
      } catch(_) {}
    }

    /* ---------- SCORING ENGINE v4 (dipakai apa adanya dari bundle kamu) ---------- */
    // Harus tersedia: computeLeadScoreDetailV4(product, qualification, identity)

    /* ---------- Analytics ---------- */
    function enableGTM() {
      if (!allowAnalytics()) return;
      const s = document.createElement("script");
      s.src = "https://www.googletagmanager.com/gtag/js?id=G-YL8ECJ5V17";
      s.async = true;
      document.head.appendChild(s);

      window.dataLayer = window.dataLayer || [];
      function gtag(){ dataLayer.push(arguments); }
      window.gtag = gtag;
      gtag('js', new Date());
      gtag('config', 'G-YL8ECJ5V17');
    }

    /* ---------- Lang helper (fallback, aman kalau chatbot.js belum expose) ---------- */
    window.getCurrentLang = window.getCurrentLang || (function(){
      return () => (document.getElementById("langSwitcher")?.value || (window.CONFIG && CONFIG.LANG_DEFAULT) || "de");
    })();

    /* ---------- Summary helpers (auto-hide kosong) ---------- */
    function buildLeadSummary(lang, productLabel, q = {}) {
      const L = {
        de: { product:"Produkt", city:"Ort", plz:"PLZ", type:"Gebäudetyp/Installation", roofForm:"Dachform", area:"Dachfläche (m²)", orient:"Ausrichtung", pitch:"Neigungswinkel (°)", shade:"Verschattung", cons:"Jahresverbrauch (kWh)", battery:"Batteriespeicher", timeline:"Zeitrahmen", contact:"Kontaktzeit", address:"Adresse", yes:"Ja", no:"Nein" },
        en: { product:"Product", city:"City", plz:"ZIP", type:"Property/Installation", roofForm:"Roof form", area:"Roof area (m²)", orient:"Orientation", pitch:"Pitch (°)", shade:"Shading", cons:"Annual usage (kWh)", battery:"Battery storage", timeline:"Timeline", contact:"Best time", address:"Address", yes:"Yes", no:"No" }
      }[lang||'de'];
      const has = v => v!==undefined && v!==null && String(v).trim()!=="";
      const pick = (...keys) => { for (const k of keys){ const v = q?.[k]; if (has(v)) return v; } return null; };
      const batteryRaw = pick("storage_interest","battery_jn");
      const batteryYesNo = (function(v){
        if (!has(v)) return null;
        const s = String(v).toLowerCase();
        if (["ja","yes","true"].includes(s)) return L.yes;
        if (["nein","no","false"].includes(s)) return L.no;
        return v;
      })(batteryRaw);
      const rows = [
        [L.product, productLabel || "-"],
        [L.city, pick("city","ort","town","stadt")],
        [L.plz, pick("plz","zip","postal_code","postleitzahl")],
        [L.type, pick("prop_type","immobilientyp","install_location","installation_location","install_on")],
        [L.roofForm, pick("roof_type","roof_form","dachform")],
        [L.area, pick("area_sqm","dachflache_m2")],
        [L.orient, pick("orientation","ausrichtung")],
        [L.pitch, pick("neigung_deg","neigungswinkel")],
        [L.shade, pick("shading","verschattung")],
        [L.cons, pick("consumption_kwh","verbrauch_kwh")],
        [L.battery, batteryYesNo ? (batteryYesNo + (has(q?.battery_kwh)?` (${q.battery_kwh} kWh)`:"")) : null],
        [L.timeline, pick("install_timeline","timeline","zeitrahmen")],
        [L.contact, pick("contact_time_window","contact_window")],
        [L.address, pick("property_street_number","address","adresse")]
      ].filter(([,v]) => has(v));
      return rows.map(([k,v]) => `${k}: ${v}`).join(" • ");
    }

    function showSummaryFromFunnel(qualification = {}) {
      const lang = (window.getCurrentLang?.() || (()=>'de'))();
      const productLabel = (window.Funnel?.state?.productLabel) || "Photovoltaik";
      const s = buildLeadSummary(lang, productLabel, qualification);
      const html = `
        <div class="summary-bubble">
          <ul>
            ${s.split(" • ").map(li => `<li>${li}</li>`).join("")}
          </ul>
        </div>
      `;
      window.appendMessage?.(html, "bot");
      trackFE("summary_view", { product: (productLabel||"pv").toLowerCase() });
    }

    function updateSummaryField(lang, key, value){
      try{
        const LABEL = (lang==="en") ? { plz:"ZIP", address:"Address" } : { plz:"PLZ", address:"Adresse" };
        const bubble = [...document.querySelectorAll(".summary-bubble")].slice(-1)[0];
        if (!bubble) return;
        const ul = bubble.querySelector("ul"); if (!ul) return;
        const label = LABEL[key];
        let li = [...ul.querySelectorAll("li")].find(node => node.textContent.trim().startsWith(label + ":"));
        const text = `${label}: ${value && String(value).trim() ? value : "-"}`;
        if (li) { li.textContent = text; } else { const newLi = document.createElement("li"); newLi.textContent = text; ul.appendChild(newLi); }
      }catch(_){}
    }

    /* ---------- Google Sheets logging ---------- */
    const GS_WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbxdmC7n29ylriM5eKct4uQx6_7rGrhF0UCRSXamS8xNqzmtBgh9SXgcP5V_-nH0oErv/exec";
    const GS_WEBHOOK_SECRET = "PV_LEADS_WEBHOOK_SECRET_8e2c7f4fb2c3412cbbde2f3e9a0c7b51";

    function logLeadToGoogleSheet(payload){
      if (!GS_WEBHOOK_URL) return;
      const data = JSON.stringify({ secret: GS_WEBHOOK_SECRET, data: payload });
      try {
        if (navigator.sendBeacon) {
          const blob = new Blob([data], { type: "text/plain;charset=utf-8" });
          navigator.sendBeacon(GS_WEBHOOK_URL, blob);
          return;
        }
      } catch (_) {}
      try {
        fetch(GS_WEBHOOK_URL, { method: "POST", mode: "no-cors", headers: { "Content-Type": "text/plain;charset=utf-8" }, body: data });
      } catch(_) {}
    }

    /* ---------- Lead → Backend (/lead) ---------- */
    async function sendLeadToBackend({productLabel, name, address, email, phone, origin, qualification}) {
      const lang = (window.getCurrentLang?.() || (()=>'de'))();
      const product = (function(p){
        const t = (p||"").toLowerCase();
        if (t.includes("photo") || t.includes("pv")) return "pv";
        if (t.includes("dach") || t.includes("roof")) return "roof";
        if (t.includes("wärme") || t.includes("waerme") || t.includes("heat") || t.includes("wp")) return "heatpump";
        if (t.includes("mieter") || t.includes("tenant")) return "tenant";
        if (t.includes("klima") || t.includes("air con") || t.includes("aircon")) return "aircon";
        if (t.includes("fenster") || t.includes("window")) return "window";
        if (t.includes("speicher") || t.includes("battery")) return "pv";
        return "pv";
      })(productLabel);

      const q = (qualification && typeof qualification === "object") ? qualification : { origin: origin || "form", product_label: productLabel };

      // SCORING v4 – dari bundle kamu (harus ada computeLeadScoreDetailV4)
      const detail = computeLeadScoreDetailV4(product, q, { name, email, phone, address });
      const { score, priority, confidence, score_breakdown, components, tags, risk_flags, next_action, sla_minutes, routing } = detail;

      const st = window.Funnel?.state || {};
      const funnel_id = st.id || st.funnelId || "default";
      const funnel_version = st.version || st.funnelVersion || "v1";
      const traceSrc = Array.isArray(st.trace) ? st.trace : Array.isArray(st.steps) ? st.steps : Array.isArray(st.log) ? st.log : null;
      const funnel_trace = traceSrc ? traceSrc.map(s => ({ id: s?.id ?? s?.key ?? "", key: s?.key ?? s?.id ?? "", label: s?.label ?? s?.title ?? "", value: s?.value ?? s?.answer ?? s?.selected ?? "" })) : null;

      const summary = buildLeadSummary(lang, productLabel, q);
      const payload = {
        source: "Website Funnel",
        product,
        qualification: q,
        contact: { name, address, email, phone, consent: true },
        score, priority, confidence,
        score_breakdown,
        score_components: components,
        tags, risk_flags,
        next_action, sla_minutes, routing,
        summary,
        notes: origin ? `Submitted via ${origin}` : "Submitted via chat funnel form",
        meta: {
          lang,
          session_id: (function(){ let s = localStorage.getItem("session_id"); if(!s){ s = Date.now()+"-"+Math.random().toString(36).slice(2); localStorage.setItem("session_id", s);} return s; })(),
          variant: (localStorage.getItem("ab_variant") || "A"),
          funnel_id, funnel_version, funnel_trace
        }
      };

      trackFE("contact_submit", { product, origin: origin||"unknown", priority, score, confidence });
      logLeadToGoogleSheet(payload);

      const res = await fetch(_api("/lead"), { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
      if (!res.ok) throw new Error("Lead push failed");
      return res.json();
    }

    /* ---------- Timeline selected → SUMMARY + POPUP ---------- */
    window.onTimelineSelected = function(timelineValue){
      const lang = (window.getCurrentLang?.() || (()=>'de'))();
      const productLabel = (window.Funnel?.state?.productLabel)
        || (document.querySelector(".product-button.selected")?.textContent)
        || "Photovoltaik";
      const qualification = (window.Funnel?.state?.data)
        ? { ...window.Funnel.state.data, timeline: timelineValue }
        : { timeline: timelineValue, product_label: productLabel };

      window.appendMessage?.(
        lang==="de"
          ? "Super, dann sind wir fast fertig. Bitte trage deine Kontaktdaten ein:"
          : "Great, we’re almost done. Please enter your contact details:",
        "bot"
      );
      showSummaryFromFunnel(qualification);
      // popup universal (chatbot.js)
      if (typeof window.openLeadForm === "function") {
        window.openLeadForm(productLabel, qualification);
      }
      trackFE("contact_open", { product: (productLabel||"pv").toLowerCase(), timeline: timelineValue });
    };

    /* ---------- Disqualified lead push ---------- */
    window.sendDisqualifiedLead = function(reason){
      const lang = (window.getCurrentLang?.() || (()=>'de'))();
      const productLabel = (window.Funnel?.state?.productLabel) || "Photovoltaik";
      const qualification = (window.Funnel?.state?.data) || {};
      const summary = buildLeadSummary(lang, productLabel, qualification);

      const st = window.Funnel?.state || {};
      const funnel_id = st.id || st.funnelId || "default";
      const funnel_version = st.version || st.funnelVersion || "v1";
      const traceSrc = Array.isArray(st.trace) ? st.trace : Array.isArray(st.steps) ? st.steps : Array.isArray(st.log) ? st.log : null;
      const funnel_trace = traceSrc ? traceSrc.map(s => ({ id: s?.id ?? s?.key ?? "", key: s?.key ?? s?.id ?? "", label: s?.label ?? s?.title ?? "", value: s?.value ?? s?.answer ?? s?.selected ?? "" })) : null;

      const payload = {
        source: "Website Funnel",
        product: (productLabel||"pv").toLowerCase(),
        qualification: { ...qualification, disqualify_reason: reason || "gate_failed" },
        contact: { name:"-", address:"-", email:"no@email.invalid", phone:"-" },
        score: 0,
        priority: "P0-BLOCK",
        confidence: 1.0,
        score_breakdown: "Disqualified by guardrail",
        tags: ["DISQUALIFIED"],
        risk_flags: ["guardrail_disqualify"],
        next_action: "Do not contact (blocked)",
        sla_minutes: null,
        routing: "N/A",
        disqualified: true,
        summary,
        notes: "Auto-disqualify gate",
        meta: {
          lang,
          session_id: (function(){ let s = localStorage.getItem("session_id"); if(!s){ s = Date.now()+"-"+Math.random().toString(36).slice(2); localStorage.setItem("session_id", s);} return s; })(),
          variant: (localStorage.getItem("ab_variant") || "A"),
          funnel_id, funnel_version, funnel_trace
        }
      };
      try {
        logLeadToGoogleSheet(payload);
        fetch(_api("/lead"), { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
      } catch(_){ }
      trackFE("disqualify", { product: payload.product, reason: payload.qualification.disqualify_reason });
    };

    /* ---------- Boot UX ---------- */
    window.addEventListener("DOMContentLoaded", () => {
      // Set judul sesuai CONFIG.CHATBOT_NAME
      try {
        const t = document.getElementById("chatbotTitle");
        if (t && window.CONFIG?.CHATBOT_NAME) t.textContent = `Chat mit ${window.CONFIG.CHATBOT_NAME}`;
      } catch(_) {}

      // Toggle open/close chatbot (kalau ada trigger)
      const btn = document.getElementById("pv-chat-trigger");
      const panel = document.getElementById("chatbot");
      btn?.addEventListener("click", () => {
        const opening = !panel.classList.contains("open");
        panel.classList.toggle("open");
        if (opening && typeof window.initChatbotOnce === "function") {
          // kalau kamu pakai lazy-init di chatbot.js
          window.initChatbotOnce();
        }
      });

      // Enable analytics jika consent
      enableGTM();
    });

    // Expose helper untuk file lain
    window.trackFE = trackFE;
    window.showSummaryFromFunnel = showSummaryFromFunnel;
    window.updateSummaryField = updateSummaryField;
    window.sendLeadToBackend = sendLeadToBackend;
  </script>
</body>
</html>
