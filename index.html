<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Planville AI Chatbot</title>

  <link rel="stylesheet" href="style.css"/>
  <!-- PWA + Icon -->
  <link rel="manifest" href="manifest.json"/>
  <link rel="icon" href="planville-logo.png" type="image/png"/>

  <!-- ===== Global Config (opsional; tdk dipakai saat rewrites) ===== -->
  <script>
    // Boleh dibiarkan untuk future use; TIDAK dipakai kalau sudah pakai Vercel rewrites
    window.CONFIG = {
      BASE_API_URL: "https://web-production-352d9.up.railway.app"
    };

    // Helper _api fallback (kalau belum didefinisikan di file lain)
    if (!window._api) {
      window._api = function(path){
        try{
          const base = (window.CONFIG?.BASE_API_URL || "").replace(/\/+$/,"");
          const p = String(path || "");
          return base + (p.startsWith("/") ? p : "/" + p);
        }catch(e){ return path; }
      };
    }

    // GANTI jika kamu redeploy GAS (pakai URL /macros/s/.../exec)
    const GS_WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbyKLXl0OVZuGNsSxMDlz-tt4zGLx9kCyUSqlKZgfPCPx5TizWGS-8FfURRLJYFW8F_9/exec";
    const GS_WEBHOOK_SECRET = "PV_LEADS_WEBHOOK_SECRET_8e2c7f4fb2c3412cbbde2f3e9a0c7b51";

    // Helpers
    function getLang(){ try { return document.getElementById("langSwitcher").value || "de"; } catch(_) { return "de"; } }
    function sessionId(){
      let s = localStorage.getItem("session_id");
      if (!s){ s = Date.now()+"-"+Math.random().toString(36).slice(2); localStorage.setItem("session_id", s); }
      return s;
    }
    function mapProduct(p){
      const t = (p||"").toLowerCase();
      if (t.includes("photo") || t.includes("pv")) return "pv";
      if (t.includes("dach") || t.includes("roof")) return "dach";
      if (t.includes("w√§rme") || t.includes("waerme") || t.includes("heat") || t.includes("wp")) return "wp";
      if (t.includes("mieter") || t.includes("tenant")) return "mieterstrom";
      if (t.includes("klima") || t.includes("air con")) return "wp";
      if (t.includes("speicher") || t.includes("battery")) return "pv";
      return "pv";
    }
    function validEmail(e){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(e||"").trim()); }
  </script>
</head>

<body>
  <!-- Intro balloon -->
  <div class="pv-balloon" role="status">
    <span>Hi! Ich bin dein Planville Assistent. Wobei darf ich helfen?</span>
  </div>

  <!-- üìå Sidebar FAQ -->
  <div class="faq-sidebar">
    <h2>Frequently Asked Questions</h2>
    <ul id="faq-list"></ul>
  </div>

  <!-- üí¨ Main Chatbot UI -->
  <div class="chatbot-container">
    <div class="chatbot-header">
      <img src="planville-logo.png" alt="Planville Logo" class="chatbot-logo"/>
      <h1>Chat with Planville AI</h1>

      <!-- Dark/Light switch -->
      <label class="switch">
        <input type="checkbox" id="modeToggle"/>
        <span class="slider"></span>
      </label>
    </div>

    <div id="chatbot-log"></div>
    <div id="typing-bubble" class="chatbot-message bot-message typing-bubble" style="display:none">...</div>

    <form id="chatbot-form">
      <input id="chatbot-input" type="text" autocomplete="off" placeholder="Type your question..."/>
      <button type="submit">üí¨</button>
    </form>

    <!-- Language switch -->
    <div class="language-switcher">
      <label for="langSwitcher">üåê Language:</label>
      <select id="langSwitcher">
        <option value="de">üá©üá™ Deutsch</option>
        <option value="en">üá¨üáß English</option>
      </select>
    </div>
  </div>

  <!-- üç™ Cookie Consent -->
  <div id="cookie-banner" class="cookie-popup" style="display:none;">
    <p id="cookie-message">Diese Website verwendet Cookies, um Ihr Erlebnis zu verbessern.</p>
    <div class="cookie-buttons">
      <button onclick="acceptCookies()">Akzeptieren</button>
      <button onclick="rejectCookies()">Ablehnen</button>
      <button onclick="openSettings()">Einstellungen</button>
    </div>
  </div>

  <!-- ‚öôÔ∏è AI guard (patched) + Chatbot -->
  <script defer src="ai_guardrails_vlite.patched.js"></script>
  <script defer src="chatbot.js"></script>

  <!-- üß† GA4 & Event/Lead helpers + bootstrapping -->
  <script>
    /* ---------- Consent & Analytics Gate ---------- */
    function getConsentState(){
      try {
        const raw = localStorage.getItem("consent_v1");
        if (raw) {
          const c = JSON.parse(raw);
          return { essential:true, analytics:!!c.analytics, marketing:!!c.marketing, personalization:!!c.personalization };
        }
      } catch(_) {}
      const simple = localStorage.getItem("cookieConsent");
      return { essential:true, analytics:simple==="accepted", marketing:false, personalization:false };
    }
    function allowAnalytics(){ return !!getConsentState().analytics; }

    // FE events (gated)
    function trackFE(eventName, props = {}, { essential = false } = {}) {
      if (!essential && !allowAnalytics()) return;
      try {
        window.dataLayer = window.dataLayer || [];
        const variant = localStorage.getItem("ab_variant") || "A";
        window.dataLayer.push(Object.assign({ event: eventName, variant }, props));
      } catch(_) {}
      try {
        fetch(_api("/track"), {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({ event: eventName, props: Object.assign({ variant: localStorage.getItem("ab_variant") || "A" }, props) })
        });
      } catch(_) {}
    }

    /* ---------- Simple scoring ---------- */
    function computeLeadScore(product, q = {}) {
      const p = (product || "").toLowerCase();
      const area = parseFloat(q.area_sqm || q.dachflache_m2 || 0) || 0;
      const orient = String(q.orientation || q.ausrichtung || "").toLowerCase();
      const verschattung = String(q.verschattung || "").toLowerCase();
      const consKwh = parseInt(q.consumption_kwh || q.verbrauch_kwh || 0, 10) || 0;
      const timeline = String(q.timeline || q.zeitrahmen || "").toLowerCase();

      let score = 50;
      if (area >= 60) score += 10;
      if (consKwh >= 3500) score += 6;
      if (timeline === "0-3" || timeline.includes("sofort") || timeline.includes("1-3")) score += 10;

      if (["pv","photovoltaik","pv-anlage"].some(k => p.includes(k))) {
        if (/(s√ºd|sued|south)/.test(orient)) score += 8;
        if (verschattung === "keine" || verschattung === "leicht" || /none|light/.test(verschattung)) score += 6;
      }
      if (p.includes("dach") || p.includes("roof")) {
        if (["undicht","leak","damage","besch√§digt"].some(k => (q.issues||"").toLowerCase().includes(k))) score += 10;
      }
      if (p.includes("wp") || p.includes("w√§rme") || p.includes("waerme") || p.includes("heat")) {
        if (parseFloat(q.living_area || 0) >= 80) score += 10;
        if (q.pv_combo === true) score += 6;
      }
      if (p.includes("mieter") || p.includes("tenant")) {
        if (parseInt(q.units || 0, 10) >= 6) score += 10;
        if (q.owner2 === true) score += 8;
      }
      if (q.qualified === false || q.disqualifyReason) score = 0;

      return Math.max(0, Math.min(100, score));
    }

    /* ---------- Analytics ---------- */
    function enableGTM() {
      if (!allowAnalytics()) return;
      const s = document.createElement("script");
      s.src = "https://www.googletagmanager.com/gtag/js?id=G-YL8ECJ5V17";
      s.async = true;
      document.head.appendChild(s);

      window.dataLayer = window.dataLayer || [];
      function gtag(){ dataLayer.push(arguments); }
      window.gtag = gtag;
      gtag('js', new Date());
      gtag('config', 'G-YL8ECJ5V17');
    }

    /* ---------- Cookie consent ---------- */
    function acceptCookies() {
      localStorage.setItem("cookieConsent", "accepted");
      localStorage.setItem("consent_v1", JSON.stringify({ analytics: true, marketing: false, personalization: false }));
      document.getElementById("cookie-banner").style.display = "none";
      enableGTM();
    }
    function rejectCookies() {
      localStorage.setItem("cookieConsent", "rejected");
      localStorage.setItem("consent_v1", JSON.stringify({ analytics: false, marketing: false, personalization: false }));
      document.getElementById("cookie-banner").style.display = "none";
    }
    function openSettings() {
      alert("Einstellungsseite ist noch in Entwicklung.");
    }

    /* ---------- Summary helpers (updated for Perspective) ---------- */
    function buildLeadSummary(lang, productLabel, q = {}) {
      const L = {
        de: {
          product:"Produkt", city:"Ort", plz:"PLZ", type:"Geb√§udetyp/Installation",
          roofForm:"Dachform", area:"Dachfl√§che (m¬≤)", orient:"Ausrichtung", pitch:"Neigungswinkel (¬∞)",
          shade:"Verschattung", cons:"Jahresverbrauch (kWh)", battery:"Batteriespeicher",
          timeline:"Zeitrahmen", contact:"Kontaktzeit", address:"Adresse", yes:"Ja", no:"Nein"
        },
        en: {
          product:"Product", city:"City", plz:"ZIP", type:"Property/Installation",
          roofForm:"Roof form", area:"Roof area (m¬≤)", orient:"Orientation", pitch:"Pitch (¬∞)",
          shade:"Shading", cons:"Annual usage (kWh)", battery:"Battery storage",
          timeline:"Timeline", contact:"Best time", address:"Address", yes:"Yes", no:"No"
        }
      }[lang||'de'];

      const get = (keys) => {
        const arr = Array.isArray(keys) ? keys : [keys];
        for (const k of arr) {
          const v = q?.[k];
          if (v !== undefined && v !== null && String(v).trim() !== "") return v;
        }
        return "-";
      };

      // battery yes/no (support flow baru: storage_interest)
      const batteryYesNo = (() => {
        const raw = get(["storage_interest","battery_jn"]);
        if (raw === "-" ) return "-";
        const t = String(raw).toLowerCase();
        if (["ja","yes","true"].includes(t)) return L.yes;
        if (["nein","no","false"].includes(t)) return L.no;
        return raw;
      })();

      return [
        `${L.product}: ${productLabel || "-"}`,
        `${L.city}: ${get(["city","ort","town","stadt"])}`,
        `${L.plz}: ${get(["plz","zip","postal_code","postleitzahl"])}`,
        `${L.type}: ${get(["prop_type","immobilientyp","install_location","installation_location","install_on"])}`,
        `${L.roofForm}: ${get(["roof_type","roof_form","dachform"])}`,
        `${L.area}: ${get(["area_sqm","dachflache_m2"])}`,
        `${L.orient}: ${get(["orientation","ausrichtung"])}`,
        `${L.pitch}: ${get(["neigung_deg","neigungswinkel"])}`,
        `${L.shade}: ${get(["shading","verschattung"])}`,
        `${L.cons}: ${get(["consumption_kwh","verbrauch_kwh"])}`,
        `${L.battery}: ${batteryYesNo}` + (q?.battery_kwh ? ` (${q.battery_kwh} kWh)` : ""),
        `${L.timeline}: ${get(["install_timeline","timeline","zeitrahmen"])}`,
        `${L.contact}: ${get(["contact_time_window","contact_window"])}`,
        `${L.address}: ${get(["property_street_number","address","adresse"])}`
      ].join(" ‚Ä¢ ");
    }

    function showSummaryFromFunnel(qualification = {}) {
      const lang = getLang();
      const productLabel = (window.Funnel?.state?.productLabel) || "Photovoltaik";
      const s = buildLeadSummary(lang, productLabel, qualification);

      const html = `
        <div class="summary-bubble">
          <ul>
            ${s.split(" ‚Ä¢ ").map(li => `<li>${li}</li>`).join("")}
          </ul>
        </div>
      `;
      appendMessage?.(html, "bot");
      trackFE("summary_view", { product: mapProduct(productLabel) });
    }

    // live-update satu baris di summary terakhir (PLZ/Address)
    function updateSummaryField(lang, key, value){
      try{
        const LABEL = (lang==="en")
          ? { plz:"ZIP", address:"Address" }
          : { plz:"PLZ", address:"Adresse" };
        const bubble = [...document.querySelectorAll(".summary-bubble")].slice(-1)[0];
        if (!bubble) return;
        const ul = bubble.querySelector("ul"); if (!ul) return;
        const label = LABEL[key];
        const li = [...ul.querySelectorAll("li")]
          .find(node => node.textContent.trim().startsWith(label + ":"));
        if (li) li.textContent = `${label}: ${value && String(value).trim() ? value : "-"}`;
      }catch(_){}
    }

    /* ---------- Google Sheets logging (sendBeacon + no-cors fallback) ---------- */
    function logLeadToGoogleSheet(payload){
      if (!GS_WEBHOOK_URL) return;
      const data = JSON.stringify({ secret: GS_WEBHOOK_SECRET, data: payload });

      try {
        if (navigator.sendBeacon) {
          const blob = new Blob([data], { type: "text/plain;charset=utf-8" });
          navigator.sendBeacon(GS_WEBHOOK_URL, blob);
          return;
        }
      } catch (_) {}

      try {
        fetch(GS_WEBHOOK_URL, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: data
        });
      } catch(_) {}
    }

    /* ---------- Lead ‚Üí Backend (/lead) ---------- */
    async function sendLeadToBackend({productLabel, name, address, email, phone, origin, qualification}) {
      const lang = getLang();
      const product = mapProduct(productLabel);
      const q = qualification && typeof qualification === "object"
        ? qualification
        : { origin: origin || "form", product_label: productLabel };

      const score = computeLeadScore(product, q);
      const summary = buildLeadSummary(lang, productLabel, q);

      const payload = {
        source: "Website Funnel",
        product,
        qualification: q,
        contact: { name, address, email, phone, consent: true },
        score,
        disqualified: false,
        summary,
        notes: origin ? `Submitted via ${origin}` : "Submitted via chat funnel form",
        meta: { lang, session_id: sessionId(), variant: (localStorage.getItem("ab_variant") || "A") }
      };

      trackFE("contact_submit", { product, origin: origin||"unknown" });

      logLeadToGoogleSheet(payload);

      const res = await fetch(_api("/lead"), {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error("Lead push failed");
      return res.json();
    }

    /* ---------- Mini contact form in chat (updated: +PLZ & live update) ---------- */
    let isSubmittingLead = false;

    function injectLeadContactFormChat(productLabel, qualification) {
      const lang = getLang();
      const log = document.getElementById("chatbot-log");
      const wrap = document.createElement("div");
      wrap.className = "chatbot-message bot-message";
      wrap.innerHTML = `
        <div style="margin-bottom:8px;font-weight:600;">
          ${lang==="de" ? "Fast geschafft! Bitte Kontaktdaten ausf√ºllen:" : "Almost done! Please fill your contact details:"}
        </div>
        <form id="lead-contact-form-chat">
          <input type="text" id="c_name"  placeholder="${lang==="de"?"Name":"Name"}" required style="width:100%;margin:4px 0;">
          <input type="text" id="c_addr"  placeholder="${lang==="de"?"Adresse (Stra√üe + Nr.)":"Address (Street + No.)"}" required style="width:100%;margin:4px 0;">
          <input type="text" id="c_plz"   placeholder="${lang==="de"?"PLZ":"ZIP"}" required style="width:100%;margin:4px 0;">
          <input type="email" id="c_email" placeholder="E-Mail" required style="width:100%;margin:4px 0;">
          <input type="tel"   id="c_phone" placeholder="${lang==="de"?"Telefonnummer":"Phone number"}" required style="width:100%;margin:4px 0;">
          <label style="display:flex;gap:.5rem;align-items:center;margin:6px 0;">
            <input type="checkbox" id="c_consent" required checked>
            <span>${lang==="de"
              ? 'Ich stimme der Kontaktaufnahme und Verarbeitung meiner Daten gem√§√ü <a href="https://planville.de/datenschutz/" target="_blank">Datenschutzerkl√§rung</a> zu.'
              : 'I agree to be contacted and for my data to be processed according to the <a href="https://planville.de/datenschutz/" target="_blank">privacy policy</a>.'}
            </span>
          </label>
          <button type="submit" class="cta-button" style="margin-top:6px;">
            ${lang==="de"?"Absenden":"Submit"}
          </button>
        </form>
      `;
      log.appendChild(wrap);

      // Prefill + live-update summary (PLZ & Address)
      const f = wrap.querySelector("#lead-contact-form-chat");
      const elAddr = f.querySelector("#c_addr");
      const elPlz  = f.querySelector("#c_plz");

      try {
        const addr = qualification?.property_street_number ? String(qualification.property_street_number) : "";
        if (addr) elAddr.value = addr, updateSummaryField(lang, "address", addr);
        const plz = qualification?.plz ? String(qualification.plz) : "";
        if (plz) elPlz.value = plz, updateSummaryField(lang, "plz", plz);
      } catch(_) {}

      elPlz.addEventListener("input", e=>{
        const v = (e.target.value||"").trim();
        if (qualification && typeof qualification === "object") qualification.plz = v;
        updateSummaryField(lang, "plz", v);
      });
      elAddr.addEventListener("input", e=>{
        const v = (e.target.value||"").trim();
        if (qualification && typeof qualification === "object") qualification.property_street_number = v;
        updateSummaryField(lang, "address", v);
      });

      const btn  = f.querySelector('button[type="submit"]');
      f.addEventListener("submit", async (e)=>{
        e.preventDefault();
        if (isSubmittingLead) return;

        const name  = f.querySelector("#c_name").value.trim();
        const addr  = elAddr.value.trim();
        const plz   = elPlz.value.trim();
        const email = f.querySelector("#c_email").value.trim();
        const phone = f.querySelector("#c_phone").value.trim();
        const ok    = f.querySelector("#c_consent").checked;

        if (!ok) { alert(lang==="de"?"Bitte Zustimmung erteilen.":"Please give consent."); return; }
        if (!validEmail(email)) { alert(lang==="de"?"Bitte eine g√ºltige E-Mail-Adresse eintragen.":"Please enter a valid email."); return; }

        // inject PLZ ke qualification agar ikut payload
        try { if (qualification && typeof qualification === "object") qualification.plz = plz; } catch(_){}

        isSubmittingLead = true;
        const original = btn.textContent;
        btn.disabled = true;
        btn.textContent = lang==="de" ? "Senden..." : "Sending...";

        try{
          await sendLeadToBackend({
            productLabel: productLabel || "Photovoltaik",
            name, address: addr, email, phone,
            origin: "chat-funnel",
            qualification: qualification || {}
          });
          appendMessage?.(lang==="de"?"Danke! Wir melden uns in K√ºrze.":"Thank you! We‚Äôll contact you shortly.","bot");
        }catch(err){
          console.error(err);
          appendMessage?.(lang==="de"?"Senden fehlgeschlagen. Bitte sp√§ter erneut versuchen.":"Submission failed. Please try again later.","bot");
        } finally {
          btn.disabled = false;
          btn.textContent = original;
          isSubmittingLead = false;
        }
      });
    }

    /* ---------- Dipanggil saat user memilih timeline ---------- */
    window.onTimelineSelected = function(timelineValue){
      const lang = getLang();

      const productLabel = (window.Funnel?.state?.productLabel)
        || (document.querySelector(".product-button.selected")?.textContent)
        || "Photovoltaik";
      const qualification = (window.Funnel?.state?.data)
        ? { ...window.Funnel.state.data, timeline: timelineValue }
        : { timeline: timelineValue, product_label: productLabel };

      // 1) Pesan biru dulu
      appendMessage?.(
        lang==="de"
          ? "Super, dann sind wir fast fertig. Bitte trage deine Kontaktdaten ein:"
          : "Great, we‚Äôre almost done. Please enter your contact details:",
        "bot"
      );
      // 2) Summary di bawah pesan
      showSummaryFromFunnel(qualification);
      // 3) Lalu form
      injectLeadContactFormChat(productLabel, qualification);

      trackFE("contact_open", { product: mapProduct(productLabel), timeline: timelineValue });
    };

    /* ---------- Kirim lead disqualified ---------- */
    window.sendDisqualifiedLead = function(reason){
      const lang = getLang();
      const productLabel = (window.Funnel?.state?.productLabel) || "Photovoltaik";
      const qualification = (window.Funnel?.state?.data) || {};
      const summary = buildLeadSummary(lang, productLabel, qualification);
      const payload = {
        source: "Website Funnel",
        product: mapProduct(productLabel),
        qualification: { ...qualification, disqualify_reason: reason || "gate_failed" },
        contact: { name:"-", address:"-", email:"no@email.invalid", phone:"-" },
        score: 0,
        disqualified: true,
        summary,
        notes: "Auto-disqualify gate",
        meta: { lang, session_id: sessionId(), variant: (localStorage.getItem("ab_variant") || "A") }
      };
      try {
        logLeadToGoogleSheet(payload);
        fetch(_api("/lead"), { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
      } catch(_){}
      trackFE("disqualify", { product: payload.product, reason: payload.qualification.disqualify_reason });
    };

    /* ---------- Bootstrapping on load ---------- */
    window.onload = function () {
      const consent = localStorage.getItem("cookieConsent");
      if (!consent) {
        document.getElementById("cookie-banner").style.display = "block";
      } else if (consent === "accepted") {
        enableGTM();
      }

      // Initial greeting (pakai showProductOptions dari chatbot.js)
      setTimeout(() => {
        appendMessage?.("Hallo! üëã Was kann ich f√ºr Sie tun?<br>Bitte w√§hlen Sie ein Thema:", "bot");
        showProductOptions?.();
      }, 800);
    };
  </script>
</body>
</html>
