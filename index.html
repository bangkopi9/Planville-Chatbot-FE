<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Planville AI Chatbot â€” Wattson</title>

  <!-- ===== CSS utama ===== -->
  <link rel="stylesheet" href="style.css"/>

  <!-- ===== PWA + Icons ===== -->
  <link rel="manifest" href="manifest.json"/>
  <link rel="icon" href="planville-logo.png" type="image/png"/>
  <!-- (Opsional) favicon svg khusus Wattson -->
  <!-- <link rel="icon" type="image/svg+xml" href="/assets/wattson.svg"> -->

  <!-- ===== Network performance hints ===== -->
  <!-- Preconnect/dns-prefetch ke API backend agar handshake lebih cepat (match CONFIG.BASE_API_URL) -->
  <link rel="preconnect" href="https://web-production-53b70.up.railway.app" crossorigin>
  <link rel="dns-prefetch" href="https://web-production-53b70.up.railway.app">
  <!-- (Opsional) GA4 preconnect (akan dipakai kalau consent OK) -->
  <link rel="preconnect" href="https://www.googletagmanager.com">
  <link rel="dns-prefetch" href="https://www.googletagmanager.com">

  <!-- ===== Global Config (eksternal) ===== -->
  <!-- Harus load lebih awal, karena guardrails & chatbot baca window.CONFIG -->
  <script defer src="config.js"></script>

  <!-- ===== Hard kill-switch CSS (rating & cookie banner di dalam chatbot) ===== -->
  <style>
    /* Sembunyikan rating ğŸ‘ğŸ‘ kalau masih ada di komponen */
    #chatbot .rating, #chatbot .thumbs, #chatbot .thumb-up, #chatbot .thumb-down,
    #chatbot [data-role="feedback"] { display:none !important; }

    /* Pastikan tidak ada cookie banner di DALAM chatbot */
    #chatbot .cookie-banner,
    #chatbot [data-cookie-banner],
    #chatbot [class*="cookie"],
    #chatbot .cmp,
    #chatbot .consent {
      display:none !important; visibility:hidden !important; pointer-events:none !important;
    }

    /* Performa UI: kurangi layout work untuk konten yang di luar viewport */
    .chat-scroll * { content-visibility:auto; contain-intrinsic-size:200px; }
  </style>
</head>

<body>
  <!-- ğŸ“Œ Sidebar FAQ -->
  <div class="faq-sidebar">
    <h2>Frequently Asked Questions</h2>
    <ul id="faq-list"></ul>
  </div>

  <!-- ğŸ’¬ Main Chatbot UI -->
  <div class="chatbot-container" id="chatbot" role="dialog" aria-label="Planville Chat â€“ Wattson" aria-modal="false">
    <div class="chatbot-header">
      <!-- Branding: logo Planville + nama Wattson -->
      <img src="planville-logo.png" alt="Planville Logo" class="chatbot-logo"/>
      <h1 id="chatbotTitle">Chat mit Wattson</h1>
    </div>

    <div id="chatbot-log" class="chat-scroll"></div>
    <div id="typing-bubble" class="chatbot-message bot-message typing-bubble" style="display:none">...</div>

    <form id="chatbot-form" autocomplete="off">
      <input id="chatbot-input" type="text" autocomplete="off" placeholder="Stell deine Frageâ€¦"/>
      <button type="submit" aria-label="Senden">ğŸ’¬</button>
    </form>

    <!-- Language switch -->
    <div class="language-switcher">
      <label for="langSwitcher">ğŸŒ Language:</label>
      <select id="langSwitcher">
        <option value="de">ğŸ‡©ğŸ‡ª Deutsch</option>
        <option value="en">ğŸ‡¬ğŸ‡§ English</option>
      </select>
    </div>
  </div>

  <!-- ğŸŸ¡ Floating Trigger: Wattson -->
  <button id="pv-chat-trigger" class="pv-chat-btn" aria-label="Chat mit Wattson Ã¶ffnen">
    <img src="/assets/wattson.svg" alt="" class="pv-chat-avatar" width="28" height="28" />
    <span class="pv-chat-label">Wattson</span>
  </button>

  <!-- âŒ (Dihapus) Cookie Consent di DALAM chatbot
       Cookie banner sebaiknya dikelola di level website/CMP, bukan di widget. -->

  <!-- âš™ï¸ AI guard (patched; akan auto-load ai_guardrails_vlite.js setelah patch) -->
  <!-- urutan: config.js â†’ patched guardrails â†’ chatbot.js -->
  <script defer src="ai_guardrails_vlite.patched.js"></script>

  <!-- ğŸ’¬ Chatbot core (NDJSON + watchdog + auto-retry) -->
  <script defer src="chatbot.js"></script>

  <!-- ğŸ§  GA4 & Event/Lead helpers + Scoring v4 (+ popup-only flow) -->
  <script>
    /* ---------- Consent & Analytics Gate ---------- */
    function getConsentState(){
      try {
        const raw = localStorage.getItem("consent_v1");
        if (raw) {
          const c = JSON.parse(raw);
          return { essential:true, analytics:!!c.analytics, marketing:!!c.marketing, personalization:!!c.personalization };
        }
      } catch(_) {}
      const simple = localStorage.getItem("cookieConsent");
      return { essential:true, analytics:simple==="accepted", marketing:false, personalization:false };
    }
    function allowAnalytics(){ return !!getConsentState().analytics; }

    // FE events (gated) â€” dipakai chatbot via window.trackFE kalau ada
    function trackFE(eventName, props = {}, { essential = false } = {}) {
      if (!essential && !allowAnalytics()) return;
      try {
        window.dataLayer = window.dataLayer || [];
        const variant = localStorage.getItem("ab_variant") || "A";
        window.dataLayer.push(Object.assign({ event: eventName, variant }, props));
      } catch(_) {}
      try {
        const ep = (window.CONFIG && (window.CONFIG.TRACK_ENDPOINT || "/track")) || "/track";
        fetch(window._api ? _api(ep) : ep, {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({
            event: eventName,
            props: Object.assign({ variant: localStorage.getItem("ab_variant") || "A" }, props)
          })
        }).catch(()=>{});
      } catch(_) {}
    }
    window.trackFE = trackFE;

    /* ---------- SCORING ENGINE v4 (punyamu) ---------- */
    // Pastikan computeLeadScoreDetailV4 tersedia di bundle-mu atau injected sebelum dipakai.

    /* ---------- Analytics (enable jika consent OK) ---------- */
    function enableGTM() {
      if (!allowAnalytics()) return;
      var GA_ID = (window.CONFIG && window.CONFIG.GTM_ID) || "";
      if (!GA_ID) return;

      const s = document.createElement("script");
      s.src = "https://www.googletagmanager.com/gtag/js?id=" + encodeURIComponent(GA_ID);
      s.async = true;
      document.head.appendChild(s);

      window.dataLayer = window.dataLayer || [];
      function gtag(){ dataLayer.push(arguments); }
      window.gtag = gtag;
      gtag('js', new Date());
      gtag('config', GA_ID);
    }
    enableGTM();

    /* ---------- Summary helpers (auto-hide kosong) ---------- */
    function getLang(){
      try { return document.getElementById("langSwitcher").value || (window.CONFIG?.LANG_DEFAULT || "de"); }
      catch(_) { return window.CONFIG?.LANG_DEFAULT || "de"; }
    }
    function mapProduct(p){
      const t = (p||"").toLowerCase();
      if (t.includes("photo") || t.includes("pv")) return "pv";
      if (t.includes("dach") || t.includes("roof")) return "roof";
      if (t.includes("wÃ¤rme") || t.includes("waerme") || t.includes("heat") || t.includes("wp")) return "heatpump";
      if (t.includes("mieter") || t.includes("tenant")) return "tenant";
      if (t.includes("klima") || t.includes("air con") || t.includes("aircon")) return "aircon";
      if (t.includes("fenster") || t.includes("window")) return "window";
      if (t.includes("speicher") || t.includes("battery")) return "pv";
      return "pv";
    }
    function sessionId(){
      let s = localStorage.getItem("session_id");
      if (!s){ s = Date.now()+"-"+Math.random().toString(36).slice(2); localStorage.setItem("session_id", s); }
      return s;
    }
    function validEmail(e){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(e||"").trim()); }

    function getFunnelMeta(){
      try{
        const st = window.Funnel?.state || {};
        const id = st.id || st.funnelId || "default";
        const version = st.version || st.funnelVersion || "v1";
        const src = Array.isArray(st.trace) ? st.trace
                  : Array.isArray(st.steps) ? st.steps
                  : Array.isArray(st.log)   ? st.log
                  : null;
        const trace = src
          ? src.map(s => ({
              id:    s?.id ?? s?.key ?? "",
              key:   s?.key ?? s?.id ?? "",
              label: s?.label ?? s?.title ?? "",
              value: s?.value ?? s?.answer ?? s?.selected ?? ""
            }))
          : null;
        return { id, version, trace };
      }catch(_){ return { id:"default", version:"v1", trace:null }; }
    }

    function buildLeadSummary(lang, productLabel, q = {}) {
      const L = {
        de: { product:"Produkt", city:"Ort", plz:"PLZ", type:"GebÃ¤udetyp/Installation", roofForm:"Dachform", area:"DachflÃ¤che (mÂ²)", orient:"Ausrichtung", pitch:"Neigungswinkel (Â°)", shade:"Verschattung", cons:"Jahresverbrauch (kWh)", battery:"Batteriespeicher", timeline:"Zeitrahmen", contact:"Kontaktzeit", address:"Adresse", yes:"Ja", no:"Nein" },
        en: { product:"Product", city:"City", plz:"ZIP", type:"Property/Installation", roofForm:"Roof form", area:"Roof area (mÂ²)", orient:"Orientation", pitch:"Pitch (Â°)", shade:"Shading", cons:"Annual usage (kWh)", battery:"Battery storage", timeline:"Timeline", contact:"Best time", address:"Address", yes:"Yes", no:"No" }
      }[lang||'de'];
      const has = v => v!==undefined && v!==null && String(v).trim()!=="";
      const pick = (...keys) => { for (const k of keys){ const v = q?.[k]; if (has(v)) return v; } return null; };
      const batteryRaw = pick("storage_interest","battery_jn");
      const batteryYesNo = (function(v){
        if (!has(v)) return null;
        const s = String(v).toLowerCase();
        if (["ja","yes","true"].includes(s)) return L.yes;
        if (["nein","no","false"].includes(s)) return L.no;
        return v;
      })(batteryRaw);
      const rows = [
        [L.product, productLabel || "-"],
        [L.city, pick("city","ort","town","stadt")],
        [L.plz, pick("plz","zip","postal_code","postleitzahl")],
        [L.type, pick("prop_type","immobilientyp","install_location","installation_location","install_on")],
        [L.roofForm, pick("roof_type","roof_form","dachform")],
        [L.area, pick("area_sqm","dachflache_m2")],
        [L.orient, pick("orientation","ausrichtung")],
        [L.pitch, pick("neigung_deg","neigungswinkel")],
        [L.shade, pick("shading","verschattung")],
        [L.cons, pick("consumption_kwh","verbrauch_kwh")],
        [L.battery, batteryYesNo ? (batteryYesNo + (has(q?.battery_kwh)?` (${q.battery_kwh} kWh)`:"")) : null],
        [L.timeline, pick("install_timeline","timeline","zeitrahmen")],
        [L.contact, pick("contact_time_window","contact_window")],
        [L.address, pick("property_street_number","address","adresse")]
      ].filter(([,v]) => has(v));
      return rows.map(([k,v]) => `${k}: ${v}`).join(" â€¢ ");
    }

    function showSummaryFromFunnel(qualification = {}) {
      const lang = getLang();
      const productLabel = (window.Funnel?.state?.productLabel) || "Photovoltaik";
      const s = buildLeadSummary(lang, productLabel, qualification);
      const html = `
        <div class="summary-bubble">
          <ul>
            ${s.split(" â€¢ ").map(li => `<li>${li}</li>`).join("")}
          </ul>
        </div>
      `;
      window.appendMessage?.(html, "bot");
      trackFE("summary_view", { product: mapProduct(productLabel) });
    }
    window.showSummaryFromFunnel = showSummaryFromFunnel;

    function updateSummaryField(lang, key, value){
      try{
        const LABEL = (lang==="en") ? { plz:"ZIP", address:"Address" } : { plz:"PLZ", address:"Adresse" };
        const bubble = [...document.querySelectorAll(".summary-bubble")].slice(-1)[0];
        if (!bubble) return;
        const ul = bubble.querySelector("ul"); if (!ul) return;
        const label = LABEL[key];
        let li = [...ul.querySelectorAll("li")].find(node => node.textContent.trim().startsWith(label + ":"));
        const text = `${label}: ${value && String(value).trim() ? value : "-"}`;
        if (li) { li.textContent = text; } else { const newLi = document.createElement("li"); newLi.textContent = text; ul.appendChild(newLi); }
      }catch(_){}}
    window.updateSummaryField = updateSummaryField;

    /* ---------- Google Sheets logging (opsional; punyamu) ---------- */
    const GS_WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbxdmC7n29ylriM5eKct4uQx6_7rGrhF0UCRSXamS8xNqzmtBgh9SXgcP5V_-nH0oErv/exec";
    const GS_WEBHOOK_SECRET = "PV_LEADS_WEBHOOK_SECRET_8e2c7f4fb2c3412cbbde2f3e9a0c7b51";
    function logLeadToGoogleSheet(payload){
      if (!GS_WEBHOOK_URL) return;
      const data = JSON.stringify({ secret: GS_WEBHOOK_SECRET, data: payload });
      try {
        if (navigator.sendBeacon) {
          const blob = new Blob([data], { type: "text/plain;charset=utf-8" });
          navigator.sendBeacon(GS_WEBHOOK_URL, blob);
          return;
        }
      } catch (_) {}
      try {
        fetch(GS_WEBHOOK_URL, { method: "POST", mode: "no-cors", headers: { "Content-Type": "text/plain;charset=utf-8" }, body: data });
      } catch(_) {}
    }

    /* ---------- Lead â†’ Backend (/lead) ---------- */
    async function sendLeadToBackend({productLabel, name, address, email, phone, origin, qualification}) {
      const lang = getLang();
      const product = mapProduct(productLabel);
      const q = (qualification && typeof qualification === "object") ? qualification : { origin: origin || "form", product_label: productLabel };

      // SCORING v4 (pakai engine yang sudah kamu bundle)
      const detail = window.computeLeadScoreDetailV4
        ? computeLeadScoreDetailV4(product, q, { name, email, phone, address })
        : { score: 50, priority: "P2", confidence: 0.7, score_breakdown: "fallback", components: {}, tags: [], risk_flags: [], next_action: "Contact", sla_minutes: 120, routing: "default" };
      const { score, priority, confidence, score_breakdown, components, tags, risk_flags, next_action, sla_minutes, routing } = detail;

      // Meta funnel
      const { id: funnel_id, version: funnel_version, trace: funnel_trace } = getFunnelMeta();

      const summary = buildLeadSummary(lang, productLabel, q);
      const payload = {
        source: "Website Funnel",
        product,
        qualification: q,
        contact: { name, address, email: (validEmail(email)?email:"â€”"), phone, consent: true },
        score, priority, confidence,
        score_breakdown,
        score_components: components,
        tags, risk_flags,
        next_action, sla_minutes, routing,
        summary,
        notes: origin ? `Submitted via ${origin}` : "Submitted via chat funnel form",
        meta: {
          lang,
          session_id: sessionId(),
          variant: (localStorage.getItem("ab_variant") || "A"),
          funnel_id, funnel_version, funnel_trace
        }
      };

      trackFE("contact_submit", { product, origin: origin||"unknown", priority, score, confidence });
      logLeadToGoogleSheet(payload);

      const ep = (window.CONFIG && (window.CONFIG.LEAD_ENDPOINT || "/lead")) || "/lead";
      const res = await fetch(window._api ? _api(ep) : ep, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error("Lead push failed");
      return res.json().catch(()=> ({}));
    }
    window.sendLeadToBackend = sendLeadToBackend;

    /* ---------- Timeline selected â†’ SUMMARY + POPUP ---------- */
    window.onTimelineSelected = function(timelineValue){
      const lang = getLang();
      const productLabel = (window.Funnel?.state?.productLabel)
        || (document.querySelector(".product-button.selected")?.textContent)
        || "Photovoltaik";
      const qualification = (window.Funnel?.state?.data)
        ? { ...window.Funnel.state.data, timeline: timelineValue }
        : { timeline: timelineValue, product_label: productLabel };

      window.appendMessage?.(
        lang==="de"
          ? "Super, dann sind wir fast fertig. Bitte trage deine Kontaktdaten ein:"
          : "Great, weâ€™re almost done. Please enter your contact details:",
        "bot"
      );
      showSummaryFromFunnel(qualification);
      // popup universal (defined in chatbot.js)
      if (typeof window.openLeadForm === "function") {
        window.openLeadForm(productLabel, qualification);
      }
      trackFE("contact_open", { product: mapProduct(productLabel), timeline: timelineValue });
    };

    /* ---------- Disqualified lead push ---------- */
    window.sendDisqualifiedLead = function(reason){
      const lang = getLang();
      const productLabel = (window.Funnel?.state?.productLabel) || "Photovoltaik";
      const qualification = (window.Funnel?.state?.data) || {};
      const summary = buildLeadSummary(lang, productLabel, qualification);

      const { id: funnel_id, version: funnel_version, trace: funnel_trace } = getFunnelMeta();

      const payload = {
        source: "Website Funnel",
        product: mapProduct(productLabel),
        qualification: { ...qualification, disqualify_reason: reason || "gate_failed" },
        contact: { name:"-", address:"-", email:"no@email.invalid", phone:"-" },
        score: 0,
        priority: "P0-BLOCK",
        confidence: 1.0,
        score_breakdown: "Disqualified by guardrail",
        tags: ["DISQUALIFIED"],
        risk_flags: ["guardrail_disqualify"],
        next_action: "Do not contact (blocked)",
        sla_minutes: null,
        routing: "N/A",
        disqualified: true,
        summary,
        notes: "Auto-disqualify gate",
        meta: {
          lang,
          session_id: sessionId(),
          variant: (localStorage.getItem("ab_variant") || "A"),
          funnel_id, funnel_version, funnel_trace
        }
      };
      try {
        logLeadToGoogleSheet(payload);
        const ep = (window.CONFIG && (window.CONFIG.LEAD_ENDPOINT || "/lead")) || "/lead";
        fetch(window._api ? _api(ep) : ep, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
      } catch(_){ }
      trackFE("disqualify", { product: payload.product, reason: payload.qualification.disqualify_reason });
    };

    /* ---------- Boot UX ---------- */
    window.addEventListener("DOMContentLoaded", () => {
      // Force A/B variant (opsional dari CONFIG)
      try {
        const f = window.CONFIG && window.CONFIG.AB_FORCE_VARIANT;
        if (f === "A" || f === "B") localStorage.setItem("ab_variant", f);
        else if (!localStorage.getItem("ab_variant")) localStorage.setItem("ab_variant", Math.random() < 0.5 ? "A" : "B");
      } catch(_) {}

      // Set judul sesuai CONFIG.CHATBOT_NAME
      try {
        const t = document.getElementById("chatbotTitle");
        if (t && window.CONFIG?.CHATBOT_NAME) t.textContent = `Chat mit ${window.CONFIG.CHATBOT_NAME}`;
      } catch(_) {}

      // Toggle open/close chatbot
      const btn = document.getElementById("pv-chat-trigger");
      const panel = document.getElementById("chatbot");
      btn?.addEventListener("click", () => {
        const opening = !panel.classList.contains("open");
        panel.classList.toggle("open");
        if (opening && typeof window.initChatbotOnce === "function") {
          // kalau kamu pakai lazy-init di chatbot.js
          window.initChatbotOnce();
        }
      });
    });
  </script>

  <noscript>
    Bitte JavaScript aktivieren, um den Wattson-Chatbot zu benutzen.
  </noscript>
</body>
</html>
