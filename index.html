<!DOCTYPE html>
<html lang="de" dir="ltr">
<head>
  <!-- ====== META / SEO / PWA ====== -->
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#18201B"/>
  <meta name="color-scheme" content="dark light"/>
  <meta name="description" content="Planville AI Chatbot â€“ Photovoltaik, Dachsanierung, WÃ¤rmepumpe, Klimaanlage, Mieterstrom. PersÃ¶nliche Beratung im Chat."/>
  <meta name="robots" content="index,follow"/>

  <link rel="icon" href="/favicon.ico"/>
  <link rel="apple-touch-icon" href="/apple-touch-icon.png"/>
  <link rel="manifest" href="/site.webmanifest"/>

  <!-- Fonts (optional) -->
  <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"/>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"/>

  <!-- Styles -->
  <link rel="stylesheet" href="style.css"/>
  <title>Planville AI Chatbot</title>

  <!-- Structured Data (Organization) -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"Organization",
    "name":"Planville GmbH",
    "url":"https://planville.de",
    "logo":"https://planville.de/logo.png",
    "sameAs":["https://www.linkedin.com/company/planville/"]
  }
  </script>

  <!-- BASIC CONFIG (frontend) -->
  <script>
    window.CONFIG = {
      BASE_API_URL: "web-production-53b70.up.railway.app", // tanpa http(s) akan di-normalize di JS
      LANG_DEFAULT: "de",
      GTM_ID: "G-YL8ECJ5V17",
      CALENDAR_URL: "",          // set kalau sudah ada (mis. Cal.com)
      STREAMING: true,
      STREAM_TRANSPORT: "sse",   // "sse" | "chunk"
      STORAGE_VERSION: "pv.1.3.0"
    };
  </script>
</head>

<body>
  <noscript>
    <strong>Diese Seite benÃ¶tigt JavaScript fÃ¼r den Chatbot. Bitte aktiviere JavaScript.</strong>
  </noscript>

  <!-- ====== HERO: ROBOT + BALLOON (click to reveal chat) ====== -->
  <section class="pv-hero" aria-label="Planville AI intro">
    <button class="pv-robot" id="pvRobot" type="button" aria-label="Chat starten (Robot)">
      <!-- Simple iconic robot (green/orange), waving hand -->
      <svg class="pv-robot-svg" width="160" height="128" viewBox="0 0 200 160" role="img" aria-hidden="true">
        <!-- Body -->
        <rect x="50" y="46" rx="14" width="110" height="76" fill="#e8eef7"></rect>
        <!-- Eyes (green) -->
        <circle cx="85" cy="84" r="7" fill="#2E8354"></circle>
        <circle cx="122" cy="84" r="7" fill="#2E8354"></circle>
        <!-- Antenna -->
        <line x1="105" y1="46" x2="105" y2="24" stroke="#2E8354" stroke-width="3"></line>
        <circle cx="105" cy="20" r="6" fill="#FFA100"></circle>
        <!-- Right hand (waving) -->
        <g class="pv-hand" transform="translate(154,62)">
          <rect x="-7" y="0" width="14" height="34" rx="7" fill="#2E8354"></rect>
          <circle cx="0" cy="-3" r="9" fill="#2E8354"></circle>
        </g>
        <!-- Left hand -->
        <g transform="translate(44,62)">
          <rect x="-7" y="0" width="14" height="34" rx="7" fill="#2E8354"></rect>
          <circle cx="0" cy="-3" r="9" fill="#2E8354"></circle>
        </g>
        <!-- Feet -->
        <rect x="70" y="122" width="26" height="10" rx="4" fill="#2E8354"></rect>
        <rect x="112" y="122" width="26" height="10" rx="4" fill="#2E8354"></rect>
      </svg>
    </button>

    <div class="pv-balloon" role="status" aria-live="polite">
      <span id="pvBalloonText">Hi! Ich bin dein Planville Assistent. Wobei darf ich helfen?</span>
    </div>
  </section>

  <!-- ====== TICKER ====== -->
  <div class="pv-ticker" aria-live="polite">
    <div class="pv-ticker-track">
      <span>here is your personal AI assistant aus Planville.de !</span>
      <span aria-hidden="true"> â€” here is your personal AI assistant aus Planville.de !</span>
      <span aria-hidden="true"> â€” here is your personal AI assistant aus Planville.de !</span>
    </div>
  </div>

  <!-- ====== LAYOUT: SIDEBAR + CHAT CONTAINER ====== -->
  <aside class="faq-sidebar" id="faqSidebar" style="display:none" aria-label="FAQ Schnellzugriff">
    <h2 id="faqTitle">Frequently Asked Questions</h2>
    <ul id="faq-list" aria-labelledby="faqTitle"></ul>
  </aside>

  <main class="chatbot-container" id="chatContainer" style="display:none" aria-label="Planville Chatbot">
    <header class="chatbot-header">
      <div style="display:flex;gap:10px;align-items:center">
        <img src="planville-logo.png" alt="Planville Logo" class="chatbot-logo" height="32" width="32"/>
        <h1 id="chatTitle" style="margin:0">Chat with Planville AI</h1>
      </div>
      <div style="display:flex;align-items:center;gap:12px">
        <!-- Language switch -->
        <div class="language-switcher" aria-label="Sprache wÃ¤hlen">
          <label for="langSwitcher" class="sr-only">Language</label>
          <select id="langSwitcher" aria-describedby="langHelp">
            <option value="de">ðŸ‡©ðŸ‡ª Deutsch</option>
            <option value="en">ðŸ‡¬ðŸ‡§ English</option>
          </select>
          <small id="langHelp" class="sr-only">Change language for the assistant</small>
        </div>
        <!-- Light/Dark toggle -->
        <label class="switch" title="Light mode">
          <input id="modeToggle" type="checkbox" aria-label="Helles Farbschema aktivieren"/>
          <span class="slider"></span>
        </label>
      </div>
    </header>

    <!-- Chat area -->
    <section id="chatSection" aria-live="polite" aria-label="Nachrichtenbereich">
      <div id="chatbot-log" role="log"></div>
      <div class="chatbot-message bot-message typing-bubble" id="typing-bubble" style="display:none">...</div>
    </section>

    <!-- Input form -->
    <form id="chatbot-form" aria-label="Nachricht senden">
      <label for="chatbot-input" class="sr-only">Ihre Nachricht</label>
      <input id="chatbot-input" type="text" autocomplete="off" placeholder="Type your question..." aria-required="true"/>
      <button id="sendBtn" type="submit" aria-label="Senden">ðŸ’¬</button>
    </form>

    <!-- Optional CTA row -->
    <div id="chat-cta-row" style="display:none"></div>
  </main>

  <!-- ====== SIMPLE CONFIGURATOR ====== -->
  <section class="config-form" id="configForm" style="display:none" aria-label="Schnell-Konfigurator">
    <h2>Produkt wÃ¤hlen</h2>
    <label for="productSelect" class="sr-only">Produkt</label>
    <select id="productSelect">
      <option value="">Bitte auswÃ¤hlen</option>
      <option value="PV-Anlage">PV-Anlage</option>
      <option value="Dachsanierung">Dachsanierung</option>
      <option value="WÃ¤rmepumpe">WÃ¤rmepumpe</option>
      <option value="Klimaanlage">Klimaanlage</option>
      <option value="SpeicherlÃ¶sung">SpeicherlÃ¶sung</option>
    </select>

    <h2>Kontaktdaten</h2>
    <input id="vorname" type="text" placeholder="Vorname" required/>
    <input id="nachname" type="text" placeholder="Nachname" required/>
    <input id="telefon" type="tel" placeholder="Telefonnummer" required/>
    <button id="submitConfig" type="button">Absenden</button>
  </section>

  <!-- ====== WIZARD (double-click mode) ====== -->
  <section class="form-wizard" id="form-wizard" style="display:none" aria-label="Lead Wizard">
    <h2>Jetzt starten</h2>
    <label for="product-choice">Produkt wÃ¤hlen:</label>
    <select id="product-choice">
      <option value="Photovoltaik">Photovoltaik</option>
      <option value="WÃ¤rmepumpe">WÃ¤rmepumpe</option>
      <option value="Klimaanlage">Klimaanlage</option>
      <option value="Dachsanierung">Dachsanierung</option>
    </select>

    <label for="fname">Vorname:</label>
    <input id="fname" type="text" required/>

    <label for="lname">Nachname:</label>
    <input id="lname" type="text" required/>

    <label for="phone">Telefonnummer:</label>
    <input id="phone" type="tel" required/>

    <button type="button" onclick="submitLead()">Absenden</button>
  </section>

  <!-- ====== COOKIE CONSENT ====== -->
  <div class="cookie-popup" id="cookie-banner" role="dialog" aria-modal="true" aria-labelledby="cookie-message">
    <p id="cookie-message">Diese Website verwendet Cookies, um Ihr Erlebnis zu verbessern.</p>
    <div class="cookie-buttons">
      <button type="button" onclick="acceptCookies()">Akzeptieren</button>
      <button type="button" onclick="rejectCookies()">Ablehnen</button>
      <button type="button" onclick="openSettings()">Einstellungen</button>
    </div>
  </div>

  <!-- Hidden templates / modal container (future use) -->
  <div id="modal-root" hidden></div>
  <template id="tpl-cta-calendar">
    <div class="quick-group">
      <button class="quick-btn">Termin buchen</button>
    </div>
  </template>

  <!-- ====== CHAT LOGIC (main) ====== -->
  <script defer src="chatbot.js"></script>

  <!-- ====== GA4 / Tracking helper ====== -->
  <script>
    function enableGTM() {
      const id = (window.CONFIG && window.CONFIG.GTM_ID) ? window.CONFIG.GTM_ID : "G-YL8ECJ5V17";
      const s = document.createElement("script");
      s.async = true; s.src = "https://www.googletagmanager.com/gtag/js?id="+id;
      document.head.appendChild(s);
      window.dataLayer = window.dataLayer || [];
      function gtag(){ dataLayer.push(arguments); }
      window.gtag = gtag;
      gtag('js', new Date());
      gtag('config', id);
    }

    function trackChatEvent(question, lang) {
      if (typeof gtag !== "undefined") {
        gtag('event','chat_message',{ event_category:'chatbot', event_label:question, language:lang });
      }
    }
    function trackFAQClick(text) {
      if (typeof gtag !== "undefined") {
        const selectedLang = document.getElementById("langSwitcher").value;
        gtag('event','faq_click',{ event_category:'faq', event_label:text, language:selectedLang });
      }
    }
    function trackConfigStart() {
      if (typeof gtag !== "undefined") {
        gtag('event','start_config_click',{ event_category:'konfigurator', event_label:'Jetzt starten' });
      }
    }
    function trackConfigSubmit(product) {
      if (typeof gtag !== "undefined") {
        gtag('event','config_submit_success',{ event_category:'konfigurator', event_label:product });
      }
    }

    function acceptCookies() {
      localStorage.setItem("cookieConsent","accepted");
      document.getElementById("cookie-banner").style.display = "none";
      enableGTM();
    }
    function rejectCookies() {
      localStorage.setItem("cookieConsent","rejected");
      document.getElementById("cookie-banner").style.display = "none";
    }
    function openSettings() {
      alert("Einstellungsseite ist noch in Entwicklung.");
    }

    function submitLead() {
      const leadData = {
        produkt: document.getElementById("product-choice").value,
        vorname: document.getElementById("fname").value,
        nachname: document.getElementById("lname").value,
        telefon: document.getElementById("phone").value
      };
      const sheetURL = "https://script.google.com/macros/s/YOUR-SCRIPT-ID/exec";
      fetch(sheetURL, {
        method: "POST",
        body: JSON.stringify(leadData),
        headers: { "Content-Type": "application/json" }
      }).then(res => {
        if (res.ok) {
          alert("Vielen Dank! Wir melden uns bald.");
          if (typeof gtag !== "undefined") {
            gtag('event','wizard_submit',{ event_category:'leadform', event_label: leadData.produkt });
          }
          document.getElementById("form-wizard").style.display = "none";
          const btn = document.getElementById("startConfigBtn");
          if (btn) btn.style.display = "block";
        } else {
          alert("Fehler beim Absenden. Bitte erneut versuchen.");
        }
      }).catch(err => {
        console.error("Fehler beim Formular:", err);
        alert("Verbindung fehlgeschlagen.");
      });
    }

    // ===== Robot reveal + i18n balloon & placeholders =====
    window.addEventListener("load", () => {
      const consent = localStorage.getItem("cookieConsent");
      if (!consent) {
        document.getElementById("cookie-banner").style.display = "block";
      } else if (consent === "accepted") {
        enableGTM();
      }

      const robot      = document.getElementById("pvRobot");
      const chat       = document.getElementById("chatContainer");
      const faq        = document.getElementById("faqSidebar");
      const langSel    = document.getElementById("langSwitcher");
      const chatTitle  = document.getElementById("chatTitle");
      const pvBalloon  = document.getElementById("pvBalloonText");
      const chatbotInp = document.getElementById("chatbot-input");

      const i18n = {
        de: {
          title: "Chatte mit Planville AI ðŸ¤–",
          balloon: "Hi! Ich bin dein Planville Assistent. Wobei darf ich helfen?",
          placeholder: "Frage eingeben...",
          faqTitle: "HÃ¤ufige Fragen"
        },
        en: {
          title: "Chat with Planville AI ðŸ¤–",
          balloon: "Hi! Iâ€™m your Planville assistant. How can I help?",
          placeholder: "Type your question...",
          faqTitle: "Frequently Asked Questions"
        }
      };

      function applyLang(lc) {
        const t = i18n[lc] || i18n.de;
        chatTitle.textContent = t.title;
        pvBalloon.textContent = t.balloon;
        chatbotInp.placeholder = t.placeholder;
        const faqTitle = document.getElementById("faqTitle");
        if (faqTitle) faqTitle.textContent = t.faqTitle;
      }

      // init language
      const savedLang = localStorage.getItem("selectedLang") || (window.CONFIG?.LANG_DEFAULT || "de");
      langSel.value = savedLang;
      applyLang(savedLang);

      if (robot) {
        robot.addEventListener("click", () => {
          chat.style.display = "flex";
          faq.style.display  = "block";
          chat.scrollIntoView({ behavior: "smooth", block: "start" });

          // initial greeting via chatbot.js utilities (prevent double)
          const onceKey = "pv_greeted";
          if (!sessionStorage.getItem(onceKey) && typeof appendMessage === "function" && typeof showProductOptions === "function") {
            appendMessage(savedLang === "de"
              ? "Hallo! ðŸ‘‹ Was kann ich fÃ¼r Sie tun?<br>Bitte wÃ¤hlen Sie ein Thema:"
              : "Hello! ðŸ‘‹ What can I do for you?<br>Please choose a topic:", "bot");
            showProductOptions();
            sessionStorage.setItem(onceKey, "1");
          }
        }, { once: true });
      }

      langSel.addEventListener("change", () => {
        const lc = langSel.value;
        localStorage.setItem("selectedLang", lc);
        applyLang(lc);
        // optional: perbarui greeting kalau chat sudah terbuka
        if (document.getElementById("chatContainer").style.display !== "none") {
          if (typeof updateUITexts === "function") updateUITexts(lc);
        }
      });

      // keyboard shortcut fokus input
      document.addEventListener("keydown", (e) => {
        if ((e.key === "/" || e.key === "F2") && document.activeElement !== chatbotInp) {
          e.preventDefault();
          chatbotInp.focus();
        }
      });

      // Simple configurator submit
      const submitCfg = document.getElementById("submitConfig");
      if (submitCfg) {
        submitCfg.addEventListener("click", async () => {
          const product  = document.getElementById("productSelect").value;
          const vorname  = document.getElementById("vorname").value.trim();
          const nachname = document.getElementById("nachname").value.trim();
          const telefon  = document.getElementById("telefon").value.trim();

          if (!product || !vorname || !nachname || !telefon) {
            alert("Bitte alle Felder ausfÃ¼llen.");
            return;
          }

          const payload = { vorname, nachname, telefon, product };
          try {
            const res = await fetch("http://localhost:8000/save-config", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });
            if (res.ok) {
              alert("Danke! Wir haben Ihre Anfrage erhalten.");
              trackConfigSubmit(product);
              document.getElementById("configForm").reset();
              document.getElementById("configForm").style.display = "none";
            } else {
              alert("Fehler beim Senden. Bitte versuchen Sie es spÃ¤ter erneut.");
            }
          } catch(err) {
            console.error(err);
            alert("Serverfehler. Bitte spÃ¤ter erneut versuchen.");
          }
        });
      }
    });
  </script>
</body>
</html>
