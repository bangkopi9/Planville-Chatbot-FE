<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Planville AI Chatbot</title>
  <link rel="stylesheet" href="style.css"/>

  <!-- ===== Global Config + API URL helper ===== -->
  <script>
    // GANTI ke domain backend Railway kamu
    window.CONFIG = {
      BASE_API_URL: "https://web-production-352d9.up.railway.app"
    };

    const GS_WEBHOOK_URL = "https://script.google.com/a/macros/planville.de/s/AKfycbyKLXl0OVZuGNsSxMDlz-tt4zGLx9kCyUSqlKZgfPCPx5TizWGS-8FfURRLJYFW8F_9/exec";
    const GS_WEBHOOK_SECRET = "PV_LEADS_WEBHOOK_SECRET_8e2c7f4fb2c3412cbbde2f3e9a0c7b51";

    // Build absolute URL ke backend
    function apiURL(path) {
      const base = (window.CONFIG?.BASE_API_URL || "").replace(/\/$/,"");
      const p = path.startsWith("/") ? path : `/${path}`;
      return base ? `${base}${p}` : p;
    }

    // Rewriter: relative → backend
    (function patchFetch(){
      const orig = window.fetch;
      window.fetch = function(input, init){
        try {
          const rewrite = (u) => {
            if (/^\/(chat|track|lead|funnel\/next|ai\/answer|save-config)(\/.*)?$/.test(u)) {
              return apiURL(u);
            }
            return u;
          };
          if (typeof input === "string") {
            input = rewrite(input);
          } else if (input && input.url) {
            const url = rewrite(input.url);
            if (url !== input.url) input = new Request(url, input);
          }
        } catch(_) {}
        return orig(input, init);
      };
    })();

    // Helpers
    function getLang(){ try { return document.getElementById("langSwitcher").value || "de"; } catch(_) { return "de"; } }
    function sessionId(){
      let s = localStorage.getItem("session_id");
      if (!s){ s = Date.now()+"-"+Math.random().toString(36).slice(2); localStorage.setItem("session_id", s); }
      return s;
    }
    function mapProduct(p){
      const t = (p||"").toLowerCase();
      if (t.includes("photo") || t.includes("pv")) return "pv";
      if (t.includes("dach") || t.includes("roof")) return "dach";
      if (t.includes("wärme") || t.includes("waerme") || t.includes("heat") || t.includes("wp")) return "wp";
      if (t.includes("mieter") || t.includes("tenant")) return "mieterstrom";
      if (t.includes("klima") || t.includes("air con")) return "wp";
      if (t.includes("speicher") || t.includes("battery")) return "pv";
      return "pv";
    }
    function validEmail(e){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(e||"").trim()); }
  </script>
</head>

<body>
  <!-- Intro balloon -->
  <div class="pv-balloon" role="status">
    <span>Hi! Ich bin dein Planville Assistent. Wobei darf ich helfen?</span>
  </div>

  <!-- 📌 Sidebar FAQ -->
  <div class="faq-sidebar">
    <h2>Frequently Asked Questions</h2>
    <ul id="faq-list"></ul>
  </div>

  <!-- 💬 Main Chatbot UI -->
  <div class="chatbot-container">
    <div class="chatbot-header">
      <img src="planville-logo.png" alt="Planville Logo" class="chatbot-logo"/>
      <h1>Chat with Planville AI</h1>

      <!-- Dark/Light switch -->
      <label class="switch">
        <input type="checkbox" id="modeToggle"/>
        <span class="slider"></span>
      </label>
    </div>

    <div id="chatbot-log"></div>
    <div id="typing-bubble" class="chatbot-message bot-message typing-bubble" style="display:none">...</div>

    <form id="chatbot-form">
      <input id="chatbot-input" type="text" autocomplete="off" placeholder="Type your question..."/>
      <button type="submit">💬</button>
    </form>

    <!-- Language switch -->
    <div class="language-switcher">
      <label for="langSwitcher">🌐 Language:</label>
      <select id="langSwitcher">
        <option value="de">🇩🇪 Deutsch</option>
        <option value="en">🇬🇧 English</option>
      </select>
    </div>
  </div>

  <!-- 🍪 Cookie Consent -->
  <div id="cookie-banner" class="cookie-popup" style="display:none;">
    <p id="cookie-message">Diese Website verwendet Cookies, um Ihr Erlebnis zu verbessern.</p>
    <div class="cookie-buttons">
      <button onclick="acceptCookies()">Akzeptieren</button>
      <button onclick="rejectCookies()">Ablehnen</button>
      <button onclick="openSettings()">Einstellungen</button>
    </div>
  </div>

  <!-- ⚙️ AI guard + Chatbot (versi revisi) -->
  <script defer src="ai_guardrails_vlite.js"></script>
  <script defer src="chatbot.js"></script>

  <!-- 🧠 GA4 & Event/Lead helpers + bootstrapping -->
  <script>
    /* ---------- Consent & Analytics Gate ---------- */
    function getConsentState(){
      try {
        const raw = localStorage.getItem("consent_v1");
        if (raw) {
          const c = JSON.parse(raw);
          return { essential:true, analytics:!!c.analytics, marketing:!!c.marketing, personalization:!!c.personalization };
        }
      } catch(_) {}
      const simple = localStorage.getItem("cookieConsent");
      return { essential:true, analytics:simple==="accepted", marketing:false, personalization:false };
    }
    function allowAnalytics(){ return !!getConsentState().analytics; }

    // FE events (gated)
    function trackFE(eventName, props = {}, { essential = false } = {}) {
      if (!essential && !allowAnalytics()) return;
      try {
        window.dataLayer = window.dataLayer || [];
        const variant = localStorage.getItem("ab_variant") || "A";
        window.dataLayer.push(Object.assign({ event: eventName, variant }, props));
      } catch(_) {}
      try {
        fetch(apiURL("/track"), {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({ event: eventName, props: Object.assign({ variant: localStorage.getItem("ab_variant") || "A" }, props) })
        });
      } catch(_) {}
    }

    /* ---------- Simple scoring ---------- */
    function computeLeadScore(product, q = {}) {
      const p = (product || "").toLowerCase();
      const area = parseFloat(q.area_sqm || q.dachflache_m2 || 0) || 0;
      const orient = String(q.orientation || q.ausrichtung || "").toLowerCase();
      const verschattung = String(q.verschattung || "").toLowerCase();
      const consKwh = parseInt(q.consumption_kwh || q.verbrauch_kwh || 0, 10) || 0;
      const timeline = String(q.timeline || q.zeitrahmen || "").toLowerCase();

      let score = 50;
      if (area >= 60) score += 10;
      if (consKwh >= 3500) score += 6;
      if (timeline === "0-3" || timeline.includes("sofort") || timeline.includes("1-3")) score += 10;

      if (["pv","photovoltaik","pv-anlage"].some(k => p.includes(k))) {
        if (/(süd|sued|south)/.test(orient)) score += 8;
        if (verschattung === "keine" || verschattung === "leicht" || /none|light/.test(verschattung)) score += 6;
      }
      if (p.includes("dach") || p.includes("roof")) {
        if (["undicht","leak","damage","beschädigt"].some(k => (q.issues||"").toLowerCase().includes(k))) score += 10;
      }
      if (p.includes("wp") || p.includes("wärme") || p.includes("waerme") || p.includes("heat")) {
        if (parseFloat(q.living_area || 0) >= 80) score += 10;
        if (q.pv_combo === true) score += 6;
      }
      if (p.includes("mieter") || p.includes("tenant")) {
        if (parseInt(q.units || 0, 10) >= 6) score += 10;
        if (q.owner2 === true) score += 8;
      }
      if (q.qualified === false || q.disqualifyReason) score = 0;

      return Math.max(0, Math.min(100, score));
    }

    /* ---------- Analytics ---------- */
    function enableGTM() {
      if (!allowAnalytics()) return;
      const s = document.createElement("script");
      s.src = "https://www.googletagmanager.com/gtag/js?id=G-YL8ECJ5V17";
      s.async = true;
      document.head.appendChild(s);

      window.dataLayer = window.dataLayer || [];
      function gtag(){ dataLayer.push(arguments); }
      window.gtag = gtag;
      gtag('js', new Date());
      gtag('config', 'G-YL8ECJ5V17');
    }

    /* ---------- Cookie consent ---------- */
    function acceptCookies() {
      localStorage.setItem("cookieConsent", "accepted");
      localStorage.setItem("consent_v1", JSON.stringify({ analytics: true, marketing: false, personalization: false }));
      document.getElementById("cookie-banner").style.display = "none";
      enableGTM();
    }
    function rejectCookies() {
      localStorage.setItem("cookieConsent", "rejected");
      localStorage.setItem("consent_v1", JSON.stringify({ analytics: false, marketing: false, personalization: false }));
      document.getElementById("cookie-banner").style.display = "none";
    }
    function openSettings() {
      alert("Einstellungsseite ist noch in Entwicklung.");
    }

    /* ---------- Summary helpers ---------- */
    function buildLeadSummary(lang, productLabel, q = {}) {
      const L = {
        de: {
          product:"Produkt", city:"Ort", plz:"PLZ", type:"Gebäudetyp", roofForm:"Dachform",
          area:"Dachfläche (m²)", orient:"Ausrichtung", pitch:"Neigungswinkel (°)",
          shade:"Verschattung", cons:"Jahresverbrauch (kWh)", battery:"Batteriespeicher",
          timeline:"Zeitrahmen", yes:"Ja", no:"Nein"
        },
        en: {
          product:"Product", city:"City", plz:"ZIP", type:"Property type", roofForm:"Roof form",
          area:"Roof area (m²)", orient:"Orientation", pitch:"Pitch (°)",
          shade:"Shading", cons:"Annual usage (kWh)", battery:"Battery storage",
          timeline:"Timeline", yes:"Yes", no:"No"
        }
      }[lang||'de'];

      const yesNo = (v) => v===true ? L.yes : (v===false ? L.no : (v ?? "-"));
      const k = (x)=> (q[x] ?? "-");

      return [
        `${L.product}: ${productLabel || "-"}`,
        `${L.city}: ${k('city')}`,
        `${L.plz}: ${k('plz')}`,
        `${L.type}: ${k('prop_type') || k('immobilientyp')}`,
        `${L.roofForm}: ${k('roof_form') || k('dachform')}`,
        `${L.area}: ${k('area_sqm') || k('dachflache_m2')}`,
        `${L.orient}: ${k('orientation') || k('ausrichtung')}`,
        `${L.pitch}: ${k('neigung_deg') || k('neigungswinkel')}`,
        `${L.shade}: ${k('shading') || k('verschattung')}`,
        `${L.cons}: ${k('consumption_kwh') || k('verbrauch_kwh')}`,
        `${L.battery}: ${yesNo(q.battery_jn)}` + (q.battery_kwh ? ` (${q.battery_kwh} kWh)` : ""),
        `${L.timeline}: ${k('timeline') || k('zeitrahmen')}`
      ].join(" • ");
    }

    function showSummaryFromFunnel(qualification = {}) {
      const lang = getLang();
      const productLabel = (window.Funnel?.state?.productLabel) || "Photovoltaik";
      const s = buildLeadSummary(lang, productLabel, qualification);

      const html = `
        <div class="summary-bubble">
          <ul>
            ${s.split(" • ").map(li => `<li>${li}</li>`).join("")}
          </ul>
        </div>
      `;
      appendMessage?.(html, "bot");
      trackFE("summary_view", { product: mapProduct(productLabel) });
    }

    /* ---------- Google Sheets logging ---------- */
    async function logLeadToGoogleSheet(payload){
      if (!GS_WEBHOOK_URL || !GS_WEBHOOK_URL.startsWith("https")) return;
      try {
        await fetch(GS_WEBHOOK_URL, {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({ secret: GS_WEBHOOK_SECRET, data: payload })
        });
      } catch(_) {}
    }

    /* ---------- Lead → Backend (/lead) ---------- */
    async function sendLeadToBackend({productLabel, name, address, email, phone, origin, qualification}) {
      const lang = getLang();
      const product = mapProduct(productLabel);
      const q = qualification && typeof qualification === "object"
        ? qualification
        : { origin: origin || "form", product_label: productLabel };

      const score = computeLeadScore(product, q);
      const summary = buildLeadSummary(lang, productLabel, q);

      const payload = {
        source: "Website Funnel",
        product,
        qualification: q,
        contact: { name, address, email, phone, consent: true },
        score,
        disqualified: false,
        summary,
        notes: origin ? `Submitted via ${origin}` : "Submitted via chat funnel form",
        meta: { lang, session_id: sessionId(), variant: (localStorage.getItem("ab_variant") || "A") }
      };

      // FE analytics (gated)
      trackFE("contact_submit", { product, origin: origin||"unknown" });

      // Send to Google Sheets (parallel)
      logLeadToGoogleSheet(payload);

      // Send to backend
      const res = await fetch(apiURL("/lead"), { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
      if (!res.ok) throw new Error("Lead push failed");
      return res.json();
    }

    /* ---------- Mini contact form in chat (appears after timeline) ---------- */
    function injectLeadContactFormChat(productLabel, qualification) {
      const lang = getLang();
      const log = document.getElementById("chatbot-log");
      const wrap = document.createElement("div");
      wrap.className = "chatbot-message bot-message";
      wrap.innerHTML = `
        <div style="margin-bottom:8px;font-weight:600;">
          ${lang==="de" ? "Fast geschafft! Bitte Kontaktdaten ausfüllen:" : "Almost done! Please fill your contact details:"}
        </div>
        <form id="lead-contact-form-chat">
          <input type="text" id="c_name"  placeholder="${lang==="de"?"Name":"Name"}" required style="width:100%;margin:4px 0;">
          <input type="text" id="c_addr"  placeholder="${lang==="de"?"Adresse":"Address"}" required style="width:100%;margin:4px 0;">
          <input type="email" id="c_email" placeholder="E-Mail" required style="width:100%;margin:4px 0;">
          <input type="tel"   id="c_phone" placeholder="${lang==="de"?"Telefonnummer":"Phone number"}" required style="width:100%;margin:4px 0;">
          <label style="display:flex;gap:.5rem;align-items:center;margin:6px 0;">
            <input type="checkbox" id="c_consent" required checked>
            <span>${lang==="de"
              ? 'Ich stimme der Kontaktaufnahme und Verarbeitung meiner Daten gemäß <a href="https://planville.de/datenschutz/" target="_blank">Datenschutzerklärung</a> zu.'
              : 'I agree to be contacted and for my data to be processed according to the <a href="https://planville.de/datenschutz/" target="_blank">privacy policy</a>.'}
            </span>
          </label>
          <button type="submit" class="cta-button" style="margin-top:6px;">
            ${lang==="de"?"Absenden":"Submit"}
          </button>
        </form>
      `;
      log.appendChild(wrap);

      document.getElementById("lead-contact-form-chat").addEventListener("submit", async (e)=>{
        e.preventDefault();
        const name  = document.getElementById("c_name").value.trim();
        const addr  = document.getElementById("c_addr").value.trim();
        const email = document.getElementById("c_email").value.trim();
        const phone = document.getElementById("c_phone").value.trim();
        const ok    = document.getElementById("c_consent").checked;
        if (!ok) { alert(lang==="de"?"Bitte Zustimmung erteilen.":"Please give consent."); return; }
        if (!validEmail(email)) { alert(lang==="de"?"Bitte eine gültige E-Mail eingeben.":"Please enter a valid email."); return; }

        try{
          await sendLeadToBackend({
            productLabel: productLabel || "Photovoltaik",
            name, address: addr, email, phone,
            origin: "chat-funnel",
            qualification: qualification || {}
          });
          appendMessage?.(lang==="de"?"Danke! Wir melden uns in Kürze.":"Thank you! We’ll contact you shortly.","bot");

          // HAPUS CTA "Jetzt buchen" setelah submit → tidak ada lagi CTA tambahan di sini
        }catch(err){
          console.error(err);
          appendMessage?.(lang==="de"?"Senden fehlgeschlagen. Bitte später erneut versuchen.":"Submission failed. Please try again later.","bot");
        }
      });
    }

    /* ---------- Dipanggil saat user memilih timeline ---------- */
    window.onTimelineSelected = function(timelineValue){
      const lang = getLang();

      const productLabel = (window.Funnel?.state?.productLabel)
        || (document.querySelector(".product-button.selected")?.textContent)
        || "Photovoltaik";
      const qualification = (window.Funnel?.state?.data)
        ? { ...window.Funnel.state.data, timeline: timelineValue }
        : { timeline: timelineValue, product_label: productLabel };

      // Tampilkan SUMMARY lebih dulu → lalu form
      showSummaryFromFunnel(qualification);

      appendMessage?.(
        lang==="de"
          ? "Super, dann sind wir fast fertig. Bitte trage deine Kontaktdaten ein:"
          : "Great, we’re almost done. Please enter your contact details:",
        "bot"
      );

      injectLeadContactFormChat(productLabel, qualification);

      trackFE("contact_open", { product: mapProduct(productLabel), timeline: timelineValue });
    };

    /* ---------- Kirim lead disqualified ---------- */
    window.sendDisqualifiedLead = function(reason){
      const lang = getLang();
      const productLabel = (window.Funnel?.state?.productLabel) || "Photovoltaik";
      const qualification = (window.Funnel?.state?.data) || {};
      const summary = buildLeadSummary(lang, productLabel, qualification);
      const payload = {
        source: "Website Funnel",
        product: mapProduct(productLabel),
        qualification: { ...qualification, disqualify_reason: reason || "gate_failed" },
        contact: { name:"-", address:"-", email:"no@email.invalid", phone:"-" },
        score: 0,
        disqualified: true,
        summary,
        notes: "Auto-disqualify gate",
        meta: { lang, session_id: sessionId(), variant: (localStorage.getItem("ab_variant") || "A") }
      };
      try {
        // log ke Sheets juga
        logLeadToGoogleSheet(payload);
        fetch(apiURL("/lead"), { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
      } catch(_){}
      trackFE("disqualify", { product: payload.product, reason: payload.qualification.disqualify_reason });
    };

    /* ---------- Bootstrapping on load ---------- */
    window.onload = function () {
      const consent = localStorage.getItem("cookieConsent");
      if (!consent) {
        document.getElementById("cookie-banner").style.display = "block";
      } else if (consent === "accepted") {
        enableGTM();
      }

      // Initial greeting (pakai showProductOptions dari chatbot.js)
      setTimeout(() => {
        appendMessage?.("Hallo! 👋 Was kann ich für Sie tun?<br>Bitte wählen Sie ein Thema:", "bot");
        showProductOptions?.();
      }, 800);
    };
  </script>
</body>
</html>
