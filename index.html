<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Planville AI Chatbot</title>
<link href="style.css" rel="stylesheet"/>
</head>
<body>
<div class="pv-balloon" role="status">
<span>Hi! Ich bin dein Planville Assistent. Wobei darf ich helfen?</span>
</div>
</div>
</div>

<!-- ğŸ“Œ Sidebar FAQ -->
<div class="faq-sidebar">
<h2>Frequently Asked Questions</h2>
<ul id="faq-list"></ul>
</div>
<!-- ğŸ’¬ Main Chatbot UI -->
<div class="chatbot-container">
<div class="chatbot-header">
<img alt="Planville Logo" class="chatbot-logo" src="planville-logo.png"/>
<h1>Chat with Planville AI</h1>
<label class="switch">
<input id="modeToggle" type="checkbox"/>
<span class="slider"></span>
</label>
</div>
<div id="chatbot-log"></div>
<div class="chatbot-message bot-message typing-bubble" id="typing-bubble" style="display:none">...</div>
<form id="chatbot-form">
<input autocomplete="off" id="chatbot-input" placeholder="Type your question..." type="text"/>
<button type="submit">ğŸ’¬</button>
</form>
<div class="language-switcher">
<label for="langSwitcher">ğŸŒ Language:</label>
<select id="langSwitcher">
<option value="de">ğŸ‡©ğŸ‡ª Deutsch</option>
<option value="en">ğŸ‡¬ğŸ‡§ English</option>
</select>
</div>
</div>
<!-- ğŸ“‹ CONFIGURATOR FORM (SIMPLE) -->
<div class="config-form" id="configForm" style="display: none;">
<h2>Produkt wÃ¤hlen</h2>
<select id="productSelect">
<option value="">Bitte auswÃ¤hlen</option>
<option value="PV-Anlage">PV-Anlage</option>
<option value="Dachsanierung">Dachsanierung</option>
<option value="WÃ¤rmepumpe">WÃ¤rmepumpe</option>
<option value="Klimaanlage">Klimaanlage</option>
<option value="SpeicherlÃ¶sung">SpeicherlÃ¶sung</option>
</select>
<h2>Kontaktdaten</h2>
<input id="vorname" placeholder="Vorname" required="" type="text"/>
<input id="nachname" placeholder="Nachname" required="" type="text"/>
<input id="telefon" placeholder="Telefonnummer" required="" type="tel"/>
<button id="submitConfig">Absenden</button>
</div>
<!-- ğŸ¯ FORM WIZARD (DOUBLE CLICK MODE) -->
<div class="form-wizard" id="form-wizard" style="display:none">
<h2>Jetzt starten</h2>
<label for="product-choice">Produkt wÃ¤hlen:</label>
<select id="product-choice">
<option value="Photovoltaik">Photovoltaik</option>
<option value="WÃ¤rmepumpe">WÃ¤rmepumpe</option>
<option value="Klimaanlage">Klimaanlage</option>
<option value="Dachsanierung">Dachsanierung</option>
</select>
<label for="fname">Vorname:</label>
<input id="fname" required="" type="text"/>
<label for="lname">Nachname:</label>
<input id="lname" required="" type="text"/>
<label for="phone">Telefonnummer:</label>
<input id="phone" required="" type="tel"/>
<button onclick="submitLead()">Absenden</button>
</div>
<!-- ğŸª Cookie Consent -->
<div class="cookie-popup" id="cookie-banner">
<p id="cookie-message">Diese Website verwendet Cookies, um Ihr Erlebnis zu verbessern.</p>
<div class="cookie-buttons">
<button onclick="acceptCookies()">Akzeptieren</button>
<button onclick="rejectCookies()">Ablehnen</button>
<button onclick="openSettings()">Einstellungen</button>
</div>
</div>
<!-- âš™ï¸ Chatbot Logic -->
<script defer="" src="chatbot.js"></script>
<!-- ğŸ§  GA4 & Event Tracking -->
<script>
    function enableGTM() {
      const script = document.createElement("script");
      script.src = "https://www.googletagmanager.com/gtag/js?id=G-YL8ECJ5V17";
      script.async = true;
      document.head.appendChild(script);

      window.dataLayer = window.dataLayer || [];
      function gtag(){ dataLayer.push(arguments); }
      window.gtag = gtag;
      gtag('js', new Date());
      gtag('config', 'G-YL8ECJ5V17');
    }

    function trackChatEvent(question, lang) {
      if (typeof gtag !== "undefined") {
        gtag('event', 'chat_message', {
          'event_category': 'chatbot',
          'event_label': question,
          'language': lang
        });
      }
    }

    function trackFAQClick(text) {
      if (typeof gtag !== "undefined") {
        const selectedLang = document.getElementById("langSwitcher").value;
        gtag('event', 'faq_click', {
          'event_category': 'faq',
          'event_label': text,
          'language': selectedLang
        });
      }
    }

    function trackConfigStart() {
      if (typeof gtag !== "undefined") {
        gtag('event', 'start_config_click', {
          'event_category': 'konfigurator',
          'event_label': 'Jetzt starten'
        });
      }
    }

    function trackConfigSubmit(product) {
      if (typeof gtag !== "undefined") {
        gtag('event', 'config_submit_success', {
          'event_category': 'konfigurator',
          'event_label': product
        });
      }
    }

    function acceptCookies() {
      localStorage.setItem("cookieConsent", "accepted");
      document.getElementById("cookie-banner").style.display = "none";
      enableGTM();
    }

    function rejectCookies() {
      localStorage.setItem("cookieConsent", "rejected");
      document.getElementById("cookie-banner").style.display = "none";
    }

    function openSettings() {
      alert("Einstellungsseite ist noch in Entwicklung.");
    }

    function submitLead() {
      const leadData = {
        produkt: document.getElementById("product-choice").value,
        vorname: document.getElementById("fname").value,
        nachname: document.getElementById("lname").value,
        telefon: document.getElementById("phone").value,
      };

      const sheetURL = "https://script.google.com/macros/s/YOUR-SCRIPT-ID/exec";

      fetch(sheetURL, {
        method: "POST",
        body: JSON.stringify(leadData),
        headers: { "Content-Type": "application/json" }
      })
      .then((res) => {
        if (res.ok) {
          alert("Vielen Dank! Wir melden uns bald.");
          if (typeof gtag !== "undefined") {
            gtag('event', 'wizard_submit', {
              event_category: 'leadform',
              event_label: leadData.produkt
            });
          }
          document.getElementById("form-wizard").style.display = "none";
          document.getElementById("startConfigBtn").style.display = "block";
        } else {
          alert("Fehler beim Absenden. Bitte erneut versuchen.");
        }
      })
      .catch((err) => {
        console.error("Fehler beim Formular:", err);
        alert("Verbindung fehlgeschlagen.");
      });
    }

    window.onload = function () {
      const consent = localStorage.getItem("cookieConsent");
      if (!consent) {
        document.getElementById("cookie-banner").style.display = "block";
      } else if (consent === "accepted") {
        enableGTM();
      }

      document.getElementById("startConfigBtn").addEventListener("click", () => {
        document.getElementById("configForm").style.display = "block";
        document.getElementById("startConfigBtn").style.display = "none";
        trackConfigStart();
      });

      document.getElementById("startConfigBtn").addEventListener("dblclick", () => {
        document.getElementById("form-wizard").style.display = "block";
        document.getElementById("startConfigBtn").style.display = "none";
      });

      document.getElementById("submitConfig").addEventListener("click", async () => {
        const product = document.getElementById("productSelect").value;
        const vorname = document.getElementById("vorname").value.trim();
        const nachname = document.getElementById("nachname").value.trim();
        const telefon = document.getElementById("telefon").value.trim();

        if (!product || !vorname || !nachname || !telefon) {
          alert("Bitte alle Felder ausfÃ¼llen.");
          return;
        }

        const payload = { vorname, nachname, telefon, product };

        try {
          const res = await fetch("http://localhost:8000/save-config", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });

          if (res.ok) {
            alert("Danke! Wir haben Ihre Anfrage erhalten.");
            trackConfigSubmit(product);
            document.getElementById("configForm").reset();
            document.getElementById("configForm").style.display = "none";
          } else {
            alert("Fehler beim Senden. Bitte versuchen Sie es spÃ¤ter erneut.");
          }
        } catch (err) {
          console.error(err);
          alert("Serverfehler. Bitte spÃ¤ter erneut versuchen.");
        }
      });

      // âœ… Initial Bot Greeting
      setTimeout(() => {
        appendMessage("Hallo! ğŸ‘‹ Was kann ich fÃ¼r Sie tun?<br>Bitte wÃ¤hlen Sie ein Thema:", "bot");
        showProductOptions();
      }, 1000);
    };

    function showProductOptions() {
      const productOptions = [
        "Photovoltaikanlage â˜€ï¸",
        "Klimaanlage â„ï¸",
        "WÃ¤rmepumpe ğŸ”¥",
        "Mieterstrom ğŸ ",
        "Dachsanierung ğŸ› ï¸"
      ];
      const container = document.createElement("div");
      container.className = "product-options";

      productOptions.forEach(product => {
        const button = document.createElement("button");
        button.innerText = product;
        button.className = "product-button";
        button.onclick = () => handleProductSelection(product);
        container.appendChild(button);
      });

      document.getElementById("chatbot-log").appendChild(container);
      scrollToBottom();
    }

    function handleProductSelection(product) {
      appendMessage(product, "user");

      setTimeout(() => {
        appendMessage(`Was mÃ¶chten Sie genau zu <b>${product}</b> wissen oder erreichen?`, "bot");
      }, 500);
    }

    function handleFinalUserInput(userText) {
      appendMessage(userText, "user");
      setTimeout(() => {
        appendMessage(
          `Vielen Dank! ğŸ˜Š Unser Team hilft Ihnen gerne weiter.<br><br>
          FÃ¼r eine persÃ¶nliche Beratung klicken Sie bitte auf den Button unten:`,
          "bot"
        );
        const btn = document.createElement("a");
        btn.href = "https://planville.de/kontakt";
        btn.target = "_blank";
        btn.className = "cta-button";
        btn.innerText = "ğŸ’¬ Jetzt Kontakt aufnehmen";
        document.getElementById("chatbot-log").appendChild(btn);
        scrollToBottom();
      }, 1000);
    }
  </script>
</body>
</html>
