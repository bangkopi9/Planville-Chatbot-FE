<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Planville AI Chatbot</title>
  <link rel="stylesheet" href="style.css" />

  <!-- ===== Global Config + API URL helper (PASTIKAN DOMAINNYA BENAR) ===== -->
  <script>
    // GANTI ke domain backend Railway kamu (disamakan satu sumber)
    window.CONFIG = {
      BASE_API_URL: "https://web-production-352d9.up.railway.app"
    };

    // Bangun URL absolut ke backend
    function apiURL(path) {
      const base = (window.CONFIG?.BASE_API_URL || "").replace(/\/$/,"");
      const p = path.startsWith("/") ? path : `/${path}`;
      return base ? `${base}${p}` : p;
    }

    // (Opsional, tapi praktis) Rewriter: arahkan panggilan relatif ke backend
    (function patchFetch(){
      const orig = window.fetch;
      window.fetch = function(input, init){
        try {
          const rewrite = (u) => {
            if (/^\/(chat|track|lead|funnel\/next|ai\/answer|save-config)(\/.*)?$/.test(u)) {
              return apiURL(u);
            }
            return u;
          };
          if (typeof input === "string") {
            input = rewrite(input);
          } else if (input && input.url) {
            const url = rewrite(input.url);
            if (url !== input.url) input = new Request(url, input);
          }
        } catch(_) {}
        return orig(input, init);
      };
    })();

    // Helper kecil
    function getLang(){ try { return document.getElementById("langSwitcher").value || "de"; } catch(_) { return "de"; } }
    function sessionId(){
      let s = localStorage.getItem("session_id");
      if (!s){ s = Date.now()+"-"+Math.random().toString(36).slice(2); localStorage.setItem("session_id", s); }
      return s;
    }
    function mapProduct(p){
      // Normalisasi label UI -> kode backend (pv|dach|wp|mieterstrom)
      const t = (p||"").toLowerCase();
      if (t.includes("photo") || t.includes("pv")) return "pv";
      if (t.includes("dach")) return "dach";
      if (t.includes("w√§rme") || t.includes("warme") || t.includes("waerme")) return "wp";
      if (t.includes("mieter")) return "mieterstrom";
      if (t.includes("klima")) return "wp"; // atau buat branch AC sendiri nanti
      if (t.includes("speicher")) return "pv"; // baterai dianggap add-on PV
      return "pv";
    }
    function validEmail(e){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(e||"").trim()); }
  </script>
</head>

<body>
  <!-- Intro balloon -->
  <div class="pv-balloon" role="status">
    <span>Hi! Ich bin dein Planville Assistent. Wobei darf ich helfen?</span>
  </div>

  <!-- üìå Sidebar FAQ -->
  <div class="faq-sidebar">
    <h2>Frequently Asked Questions</h2>
    <ul id="faq-list"></ul>
  </div>

  <!-- üí¨ Main Chatbot UI -->
  <div class="chatbot-container">
    <div class="chatbot-header">
      <img src="planville-logo.png" alt="Planville Logo" class="chatbot-logo" />
      <h1>Chat with Planville AI</h1>

    <!-- Dark/Light switch -->
      <label class="switch">
        <input type="checkbox" id="modeToggle" />
        <span class="slider"></span>
      </label>
    </div>

    <div id="chatbot-log"></div>
    <div id="typing-bubble" class="chatbot-message bot-message typing-bubble" style="display:none">...</div>

    <form id="chatbot-form">
      <input id="chatbot-input" type="text" autocomplete="off" placeholder="Type your question..." />
      <button type="submit">üí¨</button>
    </form>

    <!-- Language switch -->
    <div class="language-switcher">
      <label for="langSwitcher">üåê Language:</label>
      <select id="langSwitcher">
        <option value="de">üá©üá™ Deutsch</option>
        <option value="en">üá¨üáß English</option>
      </select>
    </div>

    <!-- CTA mulai konfigurator (dipakai oleh onload listener) -->
    <button id="startConfigBtn" type="button" class="cta-button">Jetzt starten</button>
  </div>

  <!-- üìã CONFIGURATOR FORM (SIMPLE) -->
  <div id="configForm" class="config-form" style="display:none;">
    <h2>Produkt w√§hlen</h2>
    <select id="productSelect" required>
      <option value="">Bitte ausw√§hlen</option>
      <option value="PV-Anlage">PV-Anlage</option>
      <option value="Dachsanierung">Dachsanierung</option>
      <option value="W√§rmepumpe">W√§rmepumpe</option>
      <option value="Klimaanlage">Klimaanlage</option>
      <option value="Speicherl√∂sung">Speicherl√∂sung</option>
    </select>

    <h2>Kontaktdaten</h2>
    <input type="text" id="vorname" placeholder="Vorname" required />
    <input type="text" id="nachname" placeholder="Nachname" required />
    <input type="text" id="adresse" placeholder="Adresse" required />
    <input type="email" id="email" placeholder="E-Mail" required />
    <input type="tel" id="telefon" placeholder="Telefonnummer" required />
    <button id="submitConfig" type="button">Absenden</button>
  </div>

  <!-- üéØ FORM WIZARD (DOUBLE CLICK MODE) -->
  <div id="form-wizard" class="form-wizard" style="display:none;">
    <h2>Jetzt starten</h2>

    <label for="product-choice">Produkt w√§hlen:</label>
    <select id="product-choice">
      <option value="Photovoltaik">Photovoltaik</option>
      <option value="W√§rmepumpe">W√§rmepumpe</option>
      <option value="Klimaanlage">Klimaanlage</option>
      <option value="Dachsanierung">Dachsanierung</option>
    </select>

    <label for="fname">Vorname:</label>
    <input id="fname" type="text" required />

    <label for="lname">Nachname:</label>
    <input id="lname" type="text" required />

    <label for="addr">Adresse:</label>
    <input id="addr" type="text" required />

    <label for="mail">E-Mail:</label>
    <input id="mail" type="email" required />

    <label for="phone">Telefonnummer:</label>
    <input id="phone" type="tel" required />

    <button type="button" onclick="submitLead()">Absenden</button>
  </div>

  <!-- üç™ Cookie Consent -->
  <div id="cookie-banner" class="cookie-popup" style="display:none;">
    <p id="cookie-message">Diese Website verwendet Cookies, um Ihr Erlebnis zu verbessern.</p>
    <div class="cookie-buttons">
      <button onclick="acceptCookies()">Akzeptieren</button>
      <button onclick="rejectCookies()">Ablehnen</button>
      <button onclick="openSettings()">Einstellungen</button>
    </div>
  </div>

  <!-- ‚öôÔ∏è AI Q&A ringan + Chatbot -->
  <script defer src="js/ai_guardrails_vlite.js"></script>
  <script defer src="chatbot.js"></script>

  <!-- üß† GA4 & Event/Lead helpers + bootstrapping -->
  <script>
    /* ---------- Consent & Analytics Gate (A) ---------- */
    function getConsentState(){
      try {
        const raw = localStorage.getItem("consent_v1");
        if (raw) {
          const c = JSON.parse(raw);
          return {
            essential: true,
            analytics: !!c.analytics,
            marketing: !!c.marketing,
            personalization: !!c.personalization
          };
        }
      } catch(_) {}
      const simple = localStorage.getItem("cookieConsent"); // "accepted" | "rejected"
      return { essential: true, analytics: simple === "accepted", marketing: false, personalization: false };
    }
    function allowAnalytics(){ return !!getConsentState().analytics; }

    // Single place to send FE events (gated)
    function trackFE(eventName, props = {}, { essential = false } = {}) {
      if (!essential && !allowAnalytics()) return;

      try {
        window.dataLayer = window.dataLayer || [];
        const variant = localStorage.getItem("ab_variant") || "A";
        window.dataLayer.push(Object.assign({ event: eventName, variant }, props));
      } catch(_) {}

      try {
        fetch(apiURL("/track"), {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({ event: eventName, props: Object.assign({ variant: localStorage.getItem("ab_variant") || "A" }, props) })
        });
      } catch(_) {}
    }

    /* ---------- Scoring sederhana (A) ---------- */
    function computeLeadScore(product, q = {}) {
      const p = (product || "").toLowerCase();
      const area = parseFloat(q.area_sqm || q.dachflache_m2 || 0) || 0;
      const orient = String(q.orientation || q.ausrichtung || "").toLowerCase();
      const verschattung = String(q.verschattung || "").toLowerCase();
      const consKwh = parseInt(q.consumption_kwh || q.verbrauch_kwh || 0, 10) || 0;
      const timeline = String(q.timeline || q.zeitrahmen || "").toLowerCase();

      let score = 50; // base
      if (area >= 60) score += 10;
      if (consKwh >= 3500) score += 6;
      if (timeline === "0-3" || timeline.includes("sofort") || timeline.includes("1-3")) score += 10;

      if (["pv","photovoltaik","pv-anlage"].some(k => p.includes(k))) {
        if (/(s√ºd|sued|south)/.test(orient)) score += 8;
        if (verschattung === "keine" || verschattung === "leicht") score += 6;
      }
      if (p.includes("dach")) {
        if (["undicht","leak","damage","besch√§digt"].some(k => (q.issues||"").toLowerCase().includes(k))) score += 10;
      }
      if (p.includes("wp") || p.includes("w√§rme") || p.includes("waerme") || p.includes("heat")) {
        if (parseFloat(q.living_area || 0) >= 80) score += 10;
        if (q.pv_combo === true) score += 6;
      }
      if (p.includes("mieter") || p.includes("tenant")) {
        if (parseInt(q.units || 0, 10) >= 6) score += 10;
        if (q.owner2 === true) score += 8;
      }
      if (q.qualified === false || q.disqualifyReason) score = 0;

      return Math.max(0, Math.min(100, score));
    }

    /* ---------- Analytics (B & C) ---------- */
    function enableGTM() {
      if (!allowAnalytics()) return; // gate by consent
      const s = document.createElement("script");
      s.src = "https://www.googletagmanager.com/gtag/js?id=G-YL8ECJ5V17";
      s.async = true;
      document.head.appendChild(s);

      window.dataLayer = window.dataLayer || [];
      function gtag(){ dataLayer.push(arguments); }
      window.gtag = gtag;
      gtag('js', new Date());
      gtag('config', 'G-YL8ECJ5V17');
    }

    function trackChatEvent(question, lang) {
      if (!allowAnalytics()) return;
      if (typeof gtag !== "undefined") {
        gtag('event', 'chat_message', { event_category: 'chatbot', event_label: question, language: lang });
      }
    }
    function trackFAQClick(text) {
      if (!allowAnalytics()) return;
      if (typeof gtag !== "undefined") {
        const selectedLang = document.getElementById("langSwitcher").value;
        gtag('event', 'faq_click', { event_category: 'faq', event_label: text, language: selectedLang });
      }
    }
    function trackConfigStart() {
      if (!allowAnalytics()) return;
      if (typeof gtag !== "undefined") {
        gtag('event', 'start_config_click', { event_category: 'konfigurator', event_label: 'Jetzt starten' });
      }
    }
    function trackConfigSubmit(product) {
      if (!allowAnalytics()) return;
      if (typeof gtag !== "undefined") {
        gtag('event', 'config_submit_success', { event_category: 'konfigurator', event_label: product });
      }
    }

    /* ---------- Cookie consent ---------- */
    function acceptCookies() {
      localStorage.setItem("cookieConsent", "accepted");
      document.getElementById("cookie-banner").style.display = "none";
      enableGTM();
    }
    function rejectCookies() {
      localStorage.setItem("cookieConsent", "rejected");
      document.getElementById("cookie-banner").style.display = "none";
    }
    function openSettings() {
      alert("Einstellungsseite ist noch in Entwicklung.");
    }

    /* ---------- Lead ‚Üí Backend (/lead)  (D) ---------- */
    async function sendLeadToBackend({productLabel, name, address, email, phone, origin, qualification}) {
      const lang = getLang();
      const product = mapProduct(productLabel);
      const q = qualification && typeof qualification === "object"
        ? qualification
        : { origin: origin || "form", product_label: productLabel };

      // compute score sebelum push
      const score = computeLeadScore(product, q);

      const payload = {
        source: "Website Funnel",
        product,
        qualification: q,
        contact: { name, address, email, phone },
        score,
        disqualified: false,
        notes: origin ? `Submitted via ${origin}` : "Submitted via index form",
        meta: { lang, session_id: sessionId(), variant: (localStorage.getItem("ab_variant") || "A") }
      };

      // FE analytics (gated)
      trackFE("contact_submit", { product, origin: origin||"unknown" });

      const res = await fetch(apiURL("/lead"), { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
      if (!res.ok) throw new Error("Lead push failed");
      return res.json();
    }

    /* ---------- Mini-form kontak di log chat (muncul setelah pilih timeline) ---------- */
    function injectLeadContactFormChat(productLabel, qualification) {
      const lang = getLang();
      const log = document.getElementById("chatbot-log");
      const wrap = document.createElement("div");
      wrap.className = "chatbot-message bot-message";
      wrap.innerHTML = `
        <div style="margin-bottom:8px;font-weight:600;">
          ${lang==="de" ? "Fast geschafft! Bitte Kontaktdaten ausf√ºllen:" : "Almost done! Please fill your contact details:"}
        </div>
        <form id="lead-contact-form-chat">
          <input type="text" id="c_name"  placeholder="${lang==="de"?"Name":"Name"}" required style="width:100%;margin:4px 0;">
          <input type="text" id="c_addr"  placeholder="${lang==="de"?"Adresse":"Address"}" required style="width:100%;margin:4px 0;">
          <input type="email" id="c_email" placeholder="E-Mail" required style="width:100%;margin:4px 0;">
          <input type="tel"   id="c_phone" placeholder="${lang==="de"?"Telefonnummer":"Phone number"}" required style="width:100%;margin:4px 0;">
          <label style="display:flex;gap:.5rem;align-items:center;margin:6px 0;">
            <input type="checkbox" id="c_consent" required>
            <span>${lang==="de"
              ? 'Ich stimme der Kontaktaufnahme und Verarbeitung meiner Daten gem√§√ü <a href="https://planville.de/datenschutz/" target="_blank">Datenschutzerkl√§rung</a> zu.'
              : 'I agree to be contacted and for my data to be processed according to the <a href="https://planville.de/datenschutz/" target="_blank">privacy policy</a>.'}
            </span>
          </label>
          <button type="submit" class="cta-button" style="margin-top:6px;">
            ${lang==="de"?"Absenden":"Submit"}
          </button>
        </form>
      `;
      log.appendChild(wrap);

      document.getElementById("lead-contact-form-chat").addEventListener("submit", async (e)=>{
        e.preventDefault();
        const name  = document.getElementById("c_name").value.trim();
        const addr  = document.getElementById("c_addr").value.trim();
        const email = document.getElementById("c_email").value.trim();
        const phone = document.getElementById("c_phone").value.trim();
        const ok    = document.getElementById("c_consent").checked;
        if (!ok) { alert(lang==="de"?"Bitte Zustimmung erteilen.":"Please give consent."); return; }
        if (!validEmail(email)) { alert(lang==="de"?"Bitte eine g√ºltige E-Mail eingeben.":"Please enter a valid email."); return; }

        try{
          await sendLeadToBackend({
            productLabel: productLabel || "Photovoltaik",
            name, address: addr, email, phone,
            origin: "chat-funnel",
            qualification: qualification || {}
          });
          appendMessage?.(lang==="de"?"Danke! Wir melden uns in K√ºrze.":"Thank you! We‚Äôll contact you shortly.","bot");

          const cta = document.createElement("a");
          cta.href="https://planville.de/kontakt"; cta.target="_blank";
          cta.className="cta-button"; cta.innerText = lang==="de"?"Jetzt buchen":"Contact us";
          document.getElementById("chatbot-log").appendChild(cta);
        }catch(err){
          console.error(err);
          appendMessage?.(lang==="de"?"Senden fehlgeschlagen. Bitte sp√§ter erneut versuchen.":"Submission failed. Please try again later.","bot");
        }
      });
    }

    /* ---------- Dipanggil saat user memilih timeline (E) ---------- */
    window.onTimelineSelected = function(timelineValue){
      const lang = getLang();

      const productLabel = (window.Funnel?.state?.productLabel)
        || (document.querySelector(".product-button.selected")?.textContent)
        || "Photovoltaik";
      const qualification = (window.Funnel?.state?.data)
        ? { ...window.Funnel.state.data, timeline: timelineValue }
        : { timeline: timelineValue, product_label: productLabel };

      appendMessage?.(
        lang==="de"
          ? "Super, dann sind wir fast fertig. Bitte trage deine Kontaktdaten ein:"
          : "Great, we‚Äôre almost done. Please enter your contact details:",
        "bot"
      );

      injectLeadContactFormChat(productLabel, qualification);

      // gated track
      trackFE("contact_open", { product: mapProduct(productLabel), timeline: timelineValue });
    };

    /* ---------- Kirim lead disqualified (owner/bewohner gate) (E) ---------- */
    window.sendDisqualifiedLead = function(reason){
      const lang = getLang();
      const productLabel = (window.Funnel?.state?.productLabel) || "Photovoltaik";
      const qualification = (window.Funnel?.state?.data) || {};
      const payload = {
        source: "Website Funnel",
        product: mapProduct(productLabel),
        qualification: { ...qualification, disqualify_reason: reason || "gate_failed" },
        contact: { name:"-", address:"-", email:"no@email.invalid", phone:"-" },
        score: 0,
        disqualified: true,
        notes: "Auto-disqualify gate",
        meta: { lang, session_id: sessionId(), variant: (localStorage.getItem("ab_variant") || "A") }
      };
      try {
        fetch(apiURL("/lead"), { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
      } catch(_){}
      trackFE("disqualify", { product: payload.product, reason: payload.qualification.disqualify_reason });
    };

    /* ---------- Lead form (wizard) ---------- */
    async function submitLead() {
      const productLabel = document.getElementById("product-choice").value;
      const fname  = document.getElementById("fname").value.trim();
      const lname  = document.getElementById("lname").value.trim();
      const addr   = document.getElementById("addr").value.trim();
      const mail   = document.getElementById("mail").value.trim();
      const phone  = document.getElementById("phone").value.trim();

      if (!productLabel || !fname || !lname || !addr || !mail || !phone) {
        alert("Bitte alle Felder ausf√ºllen.");
        return;
      }
      if (!validEmail(mail)) { alert("Bitte eine g√ºltige E-Mail eingeben."); return; }

      try {
        await sendLeadToBackend({
          productLabel,
          name: `${fname} ${lname}`.trim(),
          address: addr,
          email: mail,
          phone,
          origin: "wizard"
        });
        alert("Vielen Dank! Wir melden uns bald.");
        if (typeof gtag !== "undefined" && allowAnalytics()) {
          gtag('event', 'wizard_submit', { event_category: 'leadform', event_label: productLabel });
        }
        document.getElementById("form-wizard").style.display = "none";
        const btn = document.getElementById("startConfigBtn");
        if (btn) btn.style.display = "block";
      } catch (err) {
        console.error("Fehler beim Formular:", err);
        alert("Verbindung fehlgeschlagen.");
      }
    }
    window.submitLead = submitLead;

    /* ---------- Konfigurator (simple) -> kirim ke backend kamu ---------- */
    async function sendConfigSimple() {
      const productLabel = document.getElementById("productSelect").value;
      const vorname = document.getElementById("vorname").value.trim();
      const nachname = document.getElementById("nachname").value.trim();
      const adresse = document.getElementById("adresse").value.trim();
      const email   = document.getElementById("email").value.trim();
      const telefon = document.getElementById("telefon").value.trim();

      if (!productLabel || !vorname || !nachname || !adresse || !email || !telefon) {
        alert("Bitte alle Felder ausf√ºllen.");
        return;
      }
      if (!validEmail(email)) { alert("Bitte eine g√ºltige E-Mail eingeben."); return; }

      try {
        await sendLeadToBackend({
          productLabel,
          name: `${vorname} ${nachname}`.trim(),
          address: adresse,
          email,
          phone: telefon,
          origin: "simple-config"
        });
        alert("Danke! Wir haben Ihre Anfrage erhalten.");
        trackConfigSubmit(productLabel);
        document.getElementById("configForm").reset();
        document.getElementById("configForm").style.display = "none";
      } catch (err) {
        console.error(err);
        alert("Serverfehler. Bitte sp√§ter erneut versuchen.");
      }
    }

    /* ---------- Bootstrapping on load ---------- */
    window.onload = function () {
      // Cookie consent
      const consent = localStorage.getItem("cookieConsent");
      if (!consent) {
        document.getElementById("cookie-banner").style.display = "block";
      } else if (consent === "accepted") {
        enableGTM();
      }

      // Start Config button
      const btn = document.getElementById("startConfigBtn");
      if (btn) {
        btn.addEventListener("click", () => {
          document.getElementById("configForm").style.display = "block";
          btn.style.display = "none";
          trackConfigStart();
        });
        btn.addEventListener("dblclick", () => {
          document.getElementById("form-wizard").style.display = "block";
          btn.style.display = "none";
        });
      }

      // Simple config submit
      const submitCfg = document.getElementById("submitConfig");
      if (submitCfg) submitCfg.addEventListener("click", sendConfigSimple);

      // Initial greeting (pakai showProductOptions dari chatbot.js)
      setTimeout(() => {
        appendMessage?.("Hallo! üëã Was kann ich f√ºr Sie tun?<br>Bitte w√§hlen Sie ein Thema:", "bot");
        showProductOptions?.();
      }, 800);
    };
  </script>
</body>
</html>
